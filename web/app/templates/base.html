<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Админ панель{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}" />
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg">
  <header class="container py">
    <h1 class="title">Админ панель</h1>
  </header>
  <main class="container card">
    {% block content %}{% endblock %}
  </main>
  <div id="modal" class="modal" x-data="{open:false}" x-cloak x-show="open" x-transition @close-modal.window="open=false" @open-modal.window="open=true">
    <div class="modal-backdrop" @click="open=false"></div>
    <div class="modal-content" x-trap.noscroll="open" @keyup.escape.window="open=false">
      <div id="modal-body"></div>
    </div>
  </div>
  <script>
    // Global helper: refetch users tbody and optionally close modal after swap
    window.refreshUsers = function(closeAfter = false) {
      try {
        if (!window.htmx) return;
        const path = window.location.pathname || '/crm/';
        const once = (ev) => {
          if (ev.detail && ev.detail.target && ev.detail.target.id === 'users-tbody') {
            document.removeEventListener('htmx:afterSwap', once);
            if (closeAfter) {
              window.dispatchEvent(new CustomEvent('close-modal'));
            }
          }
        };
        if (closeAfter) {
          document.addEventListener('htmx:afterSwap', once, { once: true });
        }
        window.htmx.ajax('GET', path, { target: '#users-tbody', swap: 'outerHTML', select: '#users-tbody' });
      } catch (e) { /* noop */ }
    };
    // Open lightweight confirm delete modal without loading edit form
    window.openDeleteConfirm = function(userId) {
      try {
        var b = document.getElementById('modal-body');
        if (!b) return;
        b.innerHTML = (
          '<div style="padding:16px;">' +
            '<div style="font-weight:600; margin-bottom:8px; text-align:center;">Подтверждение</div>' +
            '<div style="margin-bottom:12px; text-align:center;">Вы уверены, что хотите удалить пользователя?</div>' +
            '<div style="display:flex; gap:8px; justify-content:center;">' +
              '<button class="btn-outline" type="button" onclick="window.dispatchEvent(new CustomEvent(\'close-modal\'))">Отмена</button>' +
              '<button class="btn-danger" type="button" ' +
                'hx-post="users/' + String(userId) + '/delete" ' +
                'hx-target="#modal-body" ' +
                'hx-swap="none" ' +
                'hx-trigger="click" ' +
                'hx-on:htmx:beforeRequest="this.disabled=true" ' +
                'hx-on:htmx:afterRequest="this.disabled=false" ' +
                'onclick="try{ if(window.htmx){ window.htmx.ajax(\'POST\', \'users/' + String(userId) + '/delete\', { target: \'#modal-body\', swap: \'none\' }); return; } }catch(e){} fetch(\'users/' + String(userId) + '/delete\', { method: \'POST\' }).then(function(){ try{ window.refreshUsers && window.refreshUsers(); }catch(_){} window.dispatchEvent(new CustomEvent(\'close-modal\')); });" ' +
              '>Удалить</button>' +
            '</div>' +
          '</div>'
        );
        // Open modal via Alpine event
        window.dispatchEvent(new CustomEvent('open-modal'));
      } catch (_) {}
    };
    document.addEventListener('htmx:afterSwap', (e) => {
      if (e.detail && e.detail.target && e.detail.target.id === 'modal-body') {
        // Open modal via Alpine event (avoid using Alpine private APIs)
        window.dispatchEvent(new CustomEvent('open-modal'));
      }
    });
    document.addEventListener('htmx:beforeSwap', (e) => {
      if (!(e && e.detail)) return;
      const { xhr, target, requestConfig, elt } = e.detail;
      if (!xhr) return;
      const modalEl = document.getElementById('modal');
      const isInModal = modalEl && elt ? modalEl.contains(elt) : false;
      const isModalBody = target && target.id === 'modal-body';
      const is2xx = xhr.status >= 200 && xhr.status < 300;
      const isPost = requestConfig && requestConfig.verb && requestConfig.verb.toLowerCase() === 'post';
      // For successful POSTs triggered from inside modal: refetch tbody and close when swapped
      if (isInModal && is2xx && isPost) {
        try { window.refreshUsers && window.refreshUsers(true); } catch (_) {}
        console.debug('[HTMX] refetch tbody after success POST', xhr.status);
        if (isModalBody) { e.detail.shouldSwap = false; }
        return;
      }
      // Keep explicit close on 204 when swapping modal-body
      if (isModalBody && xhr.status === 204) {
        console.debug('[HTMX] refetch tbody on 204 delete');
        try { window.refreshUsers && window.refreshUsers(true); } catch (_) {}
        e.detail.shouldSwap = false;
      }
    });
    document.addEventListener('htmx:responseError', (e) => {
      if (e.detail && e.detail.target && e.detail.target.id === 'modal-body') {
        const status = e.detail.xhr ? e.detail.xhr.status : 'Ошибка';
        alert(`Не удалось загрузить данные пользователя. Код: ${status}`);
      }
    });
    document.addEventListener('htmx:afterRequest', (e) => {
      if (!(e && e.detail)) return;
      const { xhr, target, requestConfig, elt } = e.detail;
      if (!xhr) return;
      const modalEl = document.getElementById('modal');
      const isInModal = modalEl && elt ? modalEl.contains(elt) : false;
      const isModalBody = target && target.id === 'modal-body';
      const is2xx = xhr.status >= 200 && xhr.status < 300;
      const isPost = requestConfig && requestConfig.verb && requestConfig.verb.toLowerCase() === 'post';
      if (isInModal && is2xx && isPost) {
        // no-op here; handled in beforeSwap to ensure close happens after tbody swap
      }
    });
  </script>
</body>
</html>
