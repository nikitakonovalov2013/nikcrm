<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Админ панель{% endblock %}</title>
  <link rel="apple-touch-icon" sizes="57x57" href="/crm/favicon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/crm/favicon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/crm/favicon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/crm/favicon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/crm/favicon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/crm/favicon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/crm/favicon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/crm/favicon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/crm/favicon-180x180.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/crm/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/crm/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/crm/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/crm/favicon-192x192.png">
  <link rel="shortcut icon" type="image/x-icon" href="/crm/favicon.ico">
  <link rel="icon" type="image/x-icon" href="/crm/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/crm/favicon-144x144.png">
  <meta name="msapplication-config" content="/crm/browserconfig.xml">
  <link rel="manifest" href="/crm/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}" />
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg" {% block body_attrs %}{% endblock %}>
  <div class="container py" x-data="{sidebarOpen:false}" x-effect="document.body.classList.toggle('no-scroll', sidebarOpen)">
    <div class="layout">
      <aside class="sidebar" :class="{'open': sidebarOpen}">
        <div class="sidebar-header">
          <div class="sidebar-title">Админ панель</div>
          <button class="sidebar-close" @click="sidebarOpen=false">✕</button>
        </div>
        <nav class="menu">
          {% set path = request.url.path %}
          <a class="menu-link {{ 'active' if path == '/crm/' else '' }}" href="{{ request.url_for('index') }}">Сотрудники</a>
          <a class="menu-link {{ 'active' if path.startswith('/crm/broadcast') else '' }}" href="{{ request.url_for('broadcast_page') }}">Рассылка</a>
          <a class="menu-link {{ 'active' if path.startswith('/crm/tasks') else '' }}" href="{{ request.url_for('tasks_board') }}">Задачи</a>
          <a class="menu-link {{ 'active' if path.startswith('/crm/purchases') else '' }}" href="{{ request.url_for('purchases_board') }}">Закупки</a>
          <a class="menu-link {{ 'active' if path.startswith('/crm/schedule') else '' }}" href="{{ request.url_for('schedule_page') }}">График работы</a>
          <a class="menu-link {{ 'active' if path.startswith('/crm/about') else '' }}" href="{{ request.url_for('about_page') }}">Миссия и цель</a>
          <div class="menu-section">Остатки</div>
          <a class="menu-link {{ 'active' if path.startswith('/crm/stocks') else '' }}" href="{{ request.url_for('stocks_dashboard') }}">Дашборд</a>
          <a class="menu-link {{ 'active' if path.startswith('/crm/materials/types') else '' }}" href="/crm/materials/types">Типы материалов</a>
          <a class="menu-link {{ 'active' if path == '/crm/materials' else '' }}" href="/crm/materials">Материалы</a>
          <a class="menu-link {{ 'active' if path.startswith('/crm/materials/consumptions') else '' }}" href="/crm/materials/consumptions">Расходы</a>
          <a class="menu-link {{ 'active' if path.startswith('/crm/materials/supplies') else '' }}" href="/crm/materials/supplies">Пополнения</a>
        </nav>
      </aside>
      <div class="sidebar-overlay" :class="{'open': sidebarOpen}" @click="sidebarOpen=false" @keyup.escape.window="sidebarOpen=false"></div>
      <section class="content">
        <div class="content-header">
          <button class="burger" @click="sidebarOpen=true">☰ Меню</button>
        </div>
        <div class="card">
          {% block content %}{% endblock %}
        </div>
      </section>
    </div>
  </div>
  <div id="modal" class="modal" x-data="{open:false}" x-cloak x-show="open" x-transition @close-modal.window="open=false" @open-modal.window="open=true">
    <div class="modal-backdrop" @click="open=false"></div>
    <div class="modal-content" x-trap.noscroll="open" @keyup.escape.window="open=false">
      <button class="modal-close" aria-label="Закрыть модалку" @click="open=false">✕</button>
      <div id="modal-body" class="modal-body"></div>
    </div>
  </div>

  <div id="crm-ui-dialog" class="crm-ui-dialog" aria-hidden="true">
    <div id="crm-ui-dialog-overlay" class="crm-ui-dialog-overlay"></div>
    <div id="crm-ui-dialog-panel" class="crm-ui-dialog-panel" role="dialog" aria-modal="true" aria-labelledby="crm-ui-dialog-title">
      <button id="crm-ui-dialog-close" class="crm-ui-dialog-close" type="button" aria-label="Закрыть">✕</button>
      <div class="crm-ui-dialog-head">
        <h3 id="crm-ui-dialog-title" class="crm-ui-dialog-title">Сообщение</h3>
      </div>
      <div class="crm-ui-dialog-body">
        <p id="crm-ui-dialog-message" class="crm-ui-dialog-message"></p>

        <div id="crm-ui-dialog-input-wrap" class="crm-ui-dialog-input-wrap" style="display:none">
          <input id="crm-ui-dialog-input" class="crm-ui-dialog-input" type="text" />
          <textarea id="crm-ui-dialog-textarea" class="crm-ui-dialog-textarea" rows="5" style="display:none"></textarea>
          <div id="crm-ui-dialog-error" class="crm-ui-dialog-error" style="display:none">Заполните поле</div>
        </div>
      </div>
      <div class="crm-ui-dialog-footer">
        <button id="crm-ui-dialog-cancel" class="btn-outline" type="button">Отмена</button>
        <button id="crm-ui-dialog-ok" class="btn" type="button" autofocus>ОК</button>
      </div>
    </div>
  </div>
  <script>
    // Global helper: refetch users tbody and optionally close modal after swap
    window.refreshUsers = function(closeAfter = false) {
      try {
        if (!window.htmx) return;
        const path = window.location.pathname || '/crm/';
        const once = (ev) => {
          if (ev.detail && ev.detail.target && ev.detail.target.id === 'users-tbody') {
            document.removeEventListener('htmx:afterSwap', once);
            if (closeAfter) {
              window.dispatchEvent(new CustomEvent('close-modal'));
            }
          }
        };
        if (closeAfter) {
          document.addEventListener('htmx:afterSwap', once, { once: true });
        }
        window.htmx.ajax('GET', path, { target: '#users-tbody', swap: 'outerHTML', select: '#users-tbody' });
      } catch (e) { /* noop */ }
    };
    // Open lightweight confirm delete modal without loading edit form
    window.openDeleteConfirm = function(userId) {
      try {
        var b = document.getElementById('modal-body');
        if (!b) return;
        b.innerHTML = (
          '<div style="padding:16px;">' +
            '<div style="font-weight:600; margin-bottom:8px; text-align:center;">Подтверждение</div>' +
            '<div style="margin-bottom:12px; text-align:center;">Вы уверены, что хотите удалить пользователя?</div>' +
            '<div style="display:flex; gap:8px; justify-content:center;">' +
              '<button class="btn-outline" type="button" onclick="window.dispatchEvent(new CustomEvent(\'close-modal\'))">Отмена</button>' +
              '<button class="btn-danger" type="button" ' +
                'hx-post="users/' + String(userId) + '/delete" ' +
                'hx-target="#modal-body" ' +
                'hx-swap="none" ' +
                'hx-trigger="click" ' +
                'hx-on:htmx:beforeRequest="this.disabled=true" ' +
                'hx-on:htmx:afterRequest="this.disabled=false" ' +
                'onclick="try{ if(window.htmx){ window.htmx.ajax(\'POST\', \'users/' + String(userId) + '/delete\', { target: \'#modal-body\', swap: \'none\' }); return; } }catch(e){} fetch(\'users/' + String(userId) + '/delete\', { method: \'POST\' }).then(function(){ try{ window.refreshUsers && window.refreshUsers(); }catch(_){} window.dispatchEvent(new CustomEvent(\'close-modal\')); });" ' +
              '>Удалить</button>' +
            '</div>' +
          '</div>'
        );
        // Open modal via Alpine event
        window.dispatchEvent(new CustomEvent('open-modal'));
      } catch (_) {}
    };
    document.addEventListener('htmx:afterSwap', (e) => {
      if (e.detail && e.detail.target && e.detail.target.id === 'modal-body') {
        // Open modal via Alpine event (avoid using Alpine private APIs)
        window.dispatchEvent(new CustomEvent('open-modal'));
      }
    });
    // Hide tooltips when modal opens/closes
    window.addEventListener('open-modal', () => {
      document.body.classList.add('no-tooltips');
    });
    window.addEventListener('close-modal', () => {
      document.body.classList.remove('no-tooltips');
    });
    // Hide tooltip on click by removing focus from tooltip elements
    document.addEventListener('click', (e) => {
      const el = e.target.closest('.has-tooltip');
      if (el && typeof el.blur === 'function') {
        el.blur();
      }
    });
    document.addEventListener('htmx:beforeSwap', (e) => {
      if (!(e && e.detail)) return;
      const { xhr, target, requestConfig, elt } = e.detail;
      if (!xhr) return;
      // Allow rendering validation HTML into modal even when server replies 400/422
      if (target && target.id === 'modal-body' && (xhr.status === 400 || xhr.status === 422)) {
        e.detail.shouldSwap = true;
        return;
      }
      const modalEl = document.getElementById('modal');
      const isInModal = modalEl && elt ? modalEl.contains(elt) : false;
      const isModalBody = target && target.id === 'modal-body';
      const is2xx = xhr.status >= 200 && xhr.status < 300;
      const isPost = requestConfig && requestConfig.verb && requestConfig.verb.toLowerCase() === 'post';
      const path = requestConfig && requestConfig.path ? String(requestConfig.path) : '';
      const isUsersRequest = path.includes('/users/') || path.startsWith('users/');
      // For successful POSTs triggered from inside modal: refetch tbody and close when swapped
      if (isInModal && is2xx && isPost && isUsersRequest) {
        try { window.refreshUsers && window.refreshUsers(true); } catch (_) {}
        console.debug('[HTMX] refetch tbody after success POST', xhr.status);
        if (isModalBody) { e.detail.shouldSwap = false; }
        return;
      }
      // Keep explicit close on 204 when swapping modal-body
      if (isModalBody && xhr.status === 204 && isUsersRequest) {
        console.debug('[HTMX] refetch tbody on 204 delete');
        try { window.refreshUsers && window.refreshUsers(true); } catch (_) {}
        e.detail.shouldSwap = false;
      }
    });
    document.addEventListener('htmx:responseError', (e) => {
      if (e.detail && e.detail.target && e.detail.target.id === 'modal-body') {
        const status = e.detail.xhr ? e.detail.xhr.status : 'Ошибка';
        // Don't alert on validation errors which are rendered into the modal (400/422)
        if (status === 400 || status === 422) return;
        try { window.crmAlert && window.crmAlert(`Не удалось загрузить данные. Код: ${status}`); } catch (_) {}
      }
    });
    document.addEventListener('htmx:afterRequest', (e) => {
      if (!(e && e.detail)) return;
      const { xhr, target, requestConfig, elt } = e.detail;
      if (!xhr) return;
      // Universal autoclose: if server signals close-modal, close regardless of swap settings.
      try {
        const trig = xhr.getResponseHeader('HX-Trigger');
        if (trig && String(trig).includes('close-modal')) {
          try {
            const mb = document.getElementById('modal-body');
            if (mb) mb.innerHTML = '';
          } catch (_) {}
          window.dispatchEvent(new CustomEvent('close-modal'));
          return;
        }
      } catch (_) {}
      const modalEl = document.getElementById('modal');
      const isInModal = modalEl && elt ? modalEl.contains(elt) : false;
      const isModalBody = target && target.id === 'modal-body';
      const is2xx = xhr.status >= 200 && xhr.status < 300;
      const isPost = requestConfig && requestConfig.verb && requestConfig.verb.toLowerCase() === 'post';
      if (isInModal && is2xx && isPost) {
        // Unified modal autoclose: only close when POST succeeded and we are not swapping modal-body.
        // This avoids closing the modal when server returns validation HTML into modal-body (e.g. 400).
        if (!isModalBody) {
          try {
            const mb = document.getElementById('modal-body');
            if (mb) mb.innerHTML = '';
          } catch (_) {}
          window.dispatchEvent(new CustomEvent('close-modal'));
        }
      }
    });

    // Responsive tables: auto-fill td[data-label] from thead th texts (for mobile card mode)
    function applyTableDataLabels(root) {
      try {
        const scope = root && root.querySelectorAll ? root : document;
        const tables = scope.querySelectorAll('table.table');
        tables.forEach((table) => {
          const ths = Array.from(table.querySelectorAll('thead th')).map(th => (th.textContent || '').trim());
          if (!ths.length) return;
          const rows = table.querySelectorAll('tbody tr');
          rows.forEach((tr) => {
            const tds = tr.querySelectorAll('td');
            tds.forEach((td, idx) => {
              if (!td.getAttribute('data-label') && ths[idx]) {
                td.setAttribute('data-label', ths[idx]);
              }
            });
          });
        });
      } catch (_) {}
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => applyTableDataLabels(document), { once: true });
    } else {
      applyTableDataLabels(document);
    }
    document.addEventListener('htmx:afterSwap', (e) => {
      const target = e && e.detail ? e.detail.target : null;
      if (target) applyTableDataLabels(target);
    });
  </script>

  <script defer src="{{ url_for('static', path='js/crm_refresh_bus.js') }}"></script>
  <script defer src="{{ url_for('static', path='js/crm_api_fetch.js') }}"></script>
  <script defer src="{{ url_for('static', path='js/crm_poller.js') }}"></script>
  <script defer src="{{ url_for('static', path='js/crm_live_updates.js') }}"></script>
  <script defer src="{{ url_for('static', path='js/crm_live_init.js') }}"></script>

  <script defer src="{{ url_for('static', path='js/ui_dialogs.js') }}"></script>
</body>
</html>
