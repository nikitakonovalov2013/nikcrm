{% extends base_template %}
{% block title %}–ó–∞–¥–∞—á–∏{% endblock %}
{% block content %}
<div class="tasks-header">
  <div>
    <h2 class="subtitle">–ó–∞–¥–∞—á–∏</h2>
    <div class="muted">–ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞</div>
  </div>
  <div class="tasks-header-actions">
    <a class="btn-outline" href="{{ archive_url }}">–ê—Ä—Ö–∏–≤</a>
    <button class="btn" type="button" onclick="window.tasksOpenCreate()">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
  </div>
</div>

<form class="tasks-filters" method="get" action="{{ board_url or request.url_for('tasks_board') }}">
  <div class="tasks-filters-search">
    <label class="tasks-filter">
      <span class="tasks-filter-label">–ü–æ–∏—Å–∫</span>
      <input type="text" name="q" value="{{ q or '' }}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ" />
    </label>
  </div>

  <div class="tasks-filters-row">
    <label class="tasks-filter tasks-filter-checkbox">
      <span class="tasks-filter-label">&nbsp;</span>
      <span class="checkbox-row">
        <input type="checkbox" name="mine" value="1" {% if mine %}checked{% endif %} />
        <span>–ú–æ–∏ –∑–∞–¥–∞—á–∏</span>
      </span>
    </label>

    {% if is_admin or is_manager %}
    <label class="tasks-filter tasks-filter-assignee">
      <span class="tasks-filter-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</span>
      <select name="assignee_id">
        <option value="" {% if not assignee_id %}selected{% endif %}>–í—Å–µ</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if assignee_id and (assignee_id == u.id) %}selected{% endif %}>{{ (u.first_name or '') ~ ' ' ~ (u.last_name or '') }}</option>
        {% endfor %}
      </select>
    </label>
    {% endif %}

    <label class="tasks-filter">
      <span class="tasks-filter-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
      <select name="priority">
        <option value="" {% if not priority %}selected{% endif %}>–í—Å–µ</option>
        <option value="urgent" {% if priority == 'urgent' %}selected{% endif %}>–°—Ä–æ—á–Ω—ã–µ</option>
        <option value="normal" {% if priority == 'normal' %}selected{% endif %}>–û–±—ã—á–Ω—ã–µ</option>
      </select>
    </label>

    <label class="tasks-filter">
      <span class="tasks-filter-label">–î–µ–¥–ª–∞–π–Ω</span>
      <select name="due">
        <option value="" {% if not due %}selected{% endif %}>–í—Å–µ</option>
        <option value="with_due" {% if due == 'with_due' %}selected{% endif %}>–° –¥–µ–¥–ª–∞–π–Ω–æ–º</option>
        <option value="overdue" {% if due == 'overdue' %}selected{% endif %}>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</option>
      </select>
    </label>

    <div class="tasks-filters-actions">
      <button class="btn-outline" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <a class="btn-outline" href="{{ board_url or request.url_for('tasks_board') }}">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
  </div>
</form>

<div class="kanban">
  {% for col in columns %}
    <section class="kanban-col" data-status="{{ col["status"] }}">
      <div class="kanban-col-header" role="button" tabindex="0" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
        <div class="kanban-col-title">
          <span class="kanban-col-chevron" aria-hidden="true">‚ñæ</span>
          <span class="kanban-col-title-text">{{ col["title"] }}</span>
        </div>
        <div class="kanban-col-count">{{ col.get("items", [])|length }}</div>
      </div>
      <div class="kanban-col-body" id="col-{{ col["status"] }}">
        {% for t in col.get("items", []) %}
          <div class="task-card {% if t.priority == 'urgent' %}urgent{% endif %} {% if t.is_overdue %}overdue{% endif %}" data-task-id="{{ t.id }}" onclick="window.tasksOpenDetail(this.dataset.taskId)">
            <div class="task-card-top">
              <div class="task-title">{{ t.title }}</div>
              {% if t.priority == 'urgent' %}
                <div class="task-urgent" title="–°—Ä–æ—á–Ω–æ">üî•</div>
              {% endif %}
            </div>
            <div class="task-meta">
              {% if t.due_at_str %}
                <div class="task-due">–î–æ: <b>{{ t.due_at_str }}</b></div>
              {% else %}
                <div class="task-due muted">–î–µ–¥–ª–∞–π–Ω: ‚Äî</div>
              {% endif %}
              <div class="task-assignees">
                {% if t.assignees and (t.assignees|length > 0) %}
                  <span class="task-assignee-dots-inline" aria-hidden="true">
                    {% for a in t.assignees[:3] %}
                      {% if a.get('color') %}
                        <span class="task-assignee-dot" title="{{ (a.get('first_name') or '') ~ ' ' ~ (a.get('last_name') or '') }}" style="background: {{ a.get('color') }}"></span>
                      {% endif %}
                    {% endfor %}
                    {% if t.assignees|length > 3 %}
                      <span class="task-assignee-more">+{{ (t.assignees|length - 3) }}</span>
                    {% endif %}
                  </span>
                  <span class="task-assignees-text">{{ t.assignees_str }}</span>
                {% else %}
                  <span class="muted">–û–±—â–∞—è</span>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
        {% if not col.get("items", []) %}
          <div class="kanban-empty muted">–ù–µ—Ç –∑–∞–¥–∞—á</div>
        {% endif %}
      </div>
    </section>
  {% endfor %}
</div>

<script type="application/json" id="tasks-users-json">{{ users_json|safe }}</script>

<script>
(function(){
  const COLLAPSED_KEY = 'crm.tasks.board.collapsedCols';
  const kanbanRoot = () => document.querySelector('.kanban');

  function loadCollapsed(){
    try {
      const raw = window.localStorage.getItem(COLLAPSED_KEY);
      if (raw === null) {
        return new Set(['review', 'done']);
      }
      const arr = JSON.parse(raw || '[]');
      if (!Array.isArray(arr)) return new Set();
      return new Set(arr.map(x => String(x || '').trim()).filter(Boolean));
    } catch (_){
      return new Set();
    }
  }

  function saveCollapsed(set){
    try {
      const arr = Array.from(set || []).map(x => String(x || '').trim()).filter(Boolean);
      window.localStorage.setItem(COLLAPSED_KEY, JSON.stringify(arr));
    } catch (_){ }
  }

  function applyCollapsedFromStorage(){
    const root = kanbanRoot();
    if (!root) return;
    const collapsed = loadCollapsed();
    root.querySelectorAll('.kanban-col').forEach(col => {
      const st = String(col.getAttribute('data-status') || '').trim();
      col.classList.toggle('is-collapsed', collapsed.has(st));
    });
  }

  function bindCollapseHandlers(){
    const root = kanbanRoot();
    if (!root) return;
    root.querySelectorAll('.kanban-col').forEach(col => {
      const header = col.querySelector('.kanban-col-header');
      if (!header) return;
      if (header.dataset.boundCollapse === '1') return;
      header.dataset.boundCollapse = '1';

      const toggle = () => {
        const st = String(col.getAttribute('data-status') || '').trim();
        const collapsed = loadCollapsed();
        const next = !col.classList.contains('is-collapsed');
        col.classList.toggle('is-collapsed', next);
        if (next) collapsed.add(st); else collapsed.delete(st);
        saveCollapsed(collapsed);
      };

      header.addEventListener('click', (ev) => {
        ev.preventDefault();
        toggle();
      });
      header.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          toggle();
        }
      });
    });
  }

  const modalBody = () => document.getElementById('modal-body');

  const IS_ADMIN = {% if is_admin %}true{% else %}false{% endif %};
  const IS_MANAGER = {% if is_manager %}true{% else %}false{% endif %};

  function openModal(html){
    const b = modalBody();
    if (!b) return;
    b.innerHTML = html;
    window.dispatchEvent(new CustomEvent('open-modal'));
  }

  function renderEvents(items){
    if (!items || items.length === 0) {
      return '<div class="muted">–ò—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    }
    return items.map(e => {
      const when = escapeHtml(e.created_at_str || '');
      const who = escapeHtml((e.actor && e.actor.name) ? e.actor.name : '‚Äî');
      const title = escapeHtml(e.title || e.type || '');
      let details = '';
      if (e.type === 'edited') {
        const lines = (e.payload && Array.isArray(e.payload.human)) ? e.payload.human : [];
        if (lines.length) {
          details = '<ul class="muted" style="margin-top:6px; padding-left: 18px;">' +
            lines.map(x => '<li>' + escapeHtml(String(x || '')) + '</li>').join('') +
          '</ul>';
        }
      }
      if (e.type === 'status_changed') {
        const frRaw = (e && (e.from_display || (e.payload && e.payload.from))) || '';
        const toRaw = (e && (e.to_display || (e.payload && e.payload.to))) || '';
        const fr = escapeHtml(frRaw);
        const to = escapeHtml(toRaw);
        details = '<div class="muted" style="margin-top:4px;">' + fr + ' ‚Üí ' + to + '</div>';
      }
      if (e.type === 'comment_added') {
        const hasText = !!(e.payload && e.payload.has_text);
        const pc = (e.payload && typeof e.payload.photos_count === 'number') ? e.payload.photos_count : 0;
        const parts = [];
        if (hasText) parts.push('—Ç–µ–∫—Å—Ç');
        if (pc) parts.push('—Ñ–æ—Ç–æ: ' + String(pc));
        if (parts.length) details = '<div class="muted" style="margin-top:4px;">' + escapeHtml(parts.join(', ')) + '</div>';
      }
      return (
        '<div class="task-comment">' +
          '<div class="task-comment-head">' +
            '<div class="task-comment-author">' + who + ' ¬∑ ' + title + '</div>' +
            '<div class="task-comment-ts muted">' + when + '</div>' +
          '</div>' +
          details +
        '</div>'
      );
    }).join('');
  }

  function closeModal(){
    try { const b = modalBody(); if (b) b.innerHTML = ''; } catch(_){}
    window.dispatchEvent(new CustomEvent('close-modal'));
  }

  function escapeHtml(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // Init collapse state
  applyCollapsedFromStorage();
  bindCollapseHandlers();

  function renderAssignees(users){
    if (!users || users.length === 0) return '<span class="muted">–û–±—â–∞—è</span>';
    return users.map(u => {
      const name = escapeHtml(((u.first_name || '') + ' ' + (u.last_name || '')).trim() || ('#' + u.id));
      const c = (u && u.color) ? String(u.color) : '';
      const dot = c ? ('<span class="task-assignee-dot" style="background:' + escapeHtml(c) + '"></span>') : '';
      return '<span style="display:inline-flex; align-items:center; gap:6px; margin-right:8px;">' + dot + name + '</span>';
    }).join('');
  }

  function renderComments(items){
    if (!items || items.length === 0) {
      return '<div class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç</div>';
    }
    return items.map(c => {
      const who = escapeHtml((c.author.first_name || '') + ' ' + (c.author.last_name || '')).trim() || ('#' + c.author.id);
      const when = escapeHtml(c.created_at_str || '');
      const text = c.text ? ('<div class="task-comment-text">' + escapeHtml(c.text) + '</div>') : '';
      const photos = (c.photos || []).map(p => (
        '<a href="' + escapeHtml(p.url) + '" target="_blank" rel="noopener">' +
          '<img class="task-photo" src="' + escapeHtml(p.url) + '" alt="photo" />' +
        '</a>'
      )).join('');
      return (
        '<div class="task-comment">' +
          '<div class="task-comment-head">' +
            '<div class="task-comment-author">' + who + '</div>' +
            '<div class="task-comment-ts muted">' + when + '</div>' +
          '</div>' +
          text +
          (photos ? ('<div class="task-photos">' + photos + '</div>') : '') +
        '</div>'
      );
    }).join('');
  }

  function renderDetailModal(task){
    const due = task.due_at_str ? ('<div>–î–µ–¥–ª–∞–π–Ω: <b>' + escapeHtml(task.due_at_str) + '</b></div>') : '<div class="muted">–î–µ–¥–ª–∞–π–Ω: ‚Äî</div>';
    const priority = task.priority === 'urgent' ? '<span class="task-pill urgent">–°—Ä–æ—á–Ω–æ</span>' : '<span class="task-pill">–û–±—ã—á–Ω–æ</span>';
    const statusMap = { new: '–ù–æ–≤—ã–µ', in_progress: '–í —Ä–∞–±–æ—Ç–µ', review: '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', done: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', archived: '–ê—Ä—Ö–∏–≤' };
    const status = '<span class="task-pill">' + escapeHtml(statusMap[task.status] || task.status) + '</span>';

    const can = task.permissions || {};

    const actionBtns = [
      can.take_in_progress ? '<button class="btn" type="button" onclick="window.tasksChangeStatus(' + task.id + ',\'in_progress\')">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>' : '',
      can.finish_to_review ? '<button class="btn" type="button" onclick="window.tasksChangeStatus(' + task.id + ',\'review\')">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>' : '',
      can.accept_done ? '<button class="btn" type="button" onclick="window.tasksChangeStatus(' + task.id + ',\'done\')">–ü—Ä–∏–Ω—è—Ç—å</button>' : '',
      can.send_back ? '<button class="btn-warn" type="button" onclick="window.tasksSendBackPrompt(' + task.id + ')">–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É</button>' : '',
      can.archive ? '<button class="btn-outline" type="button" onclick="window.tasksArchive(' + task.id + ')">–í –∞—Ä—Ö–∏–≤</button>' : '',
      (IS_ADMIN || IS_MANAGER) ? '<button class="btn-outline" type="button" onclick="window.tasksOpenEdit(' + task.id + ')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>' : ''
    ].filter(Boolean).join('');

    const mainPhotoUrl = task.photo_url || task.photo_path;
    const proxyPhotoUrl = (task.tg_photo_file_id || task.photo_file_id) ? ('/crm/tasks/' + task.id + '/photo') : '';
    const effectivePhotoUrl = mainPhotoUrl || proxyPhotoUrl;
    const taskPhoto = effectivePhotoUrl
      ? (
          '<div class="task-main-photo">' +
            '<a href="' + escapeHtml(effectivePhotoUrl) + '" target="_blank" rel="noopener">' +
              '<img class="task-main-photo-img" src="' + escapeHtml(effectivePhotoUrl) + '" alt="task photo" />' +
            '</a>' +
          '</div>'
        )
      : '';

    const html = (
      '<div class="modal-header">–ó–∞–¥–∞—á–∞ #' + task.id + '</div>' +
      '<div class="modal-body tasks-modal">' +
        '<div class="task-detail-head">' +
          '<div class="task-detail-title">' + escapeHtml(task.title) + '</div>' +
          '<div class="task-detail-badges">' + priority + status + '</div>' +
        '</div>' +
        taskPhoto +
        (task.description ? ('<div class="task-detail-desc">' + escapeHtml(task.description) + '</div>') : '<div class="muted">–û–ø–∏—Å–∞–Ω–∏–µ: ‚Äî</div>') +
        '<div class="divider"></div>' +
        '<div class="task-detail-meta">' +
          '<div class="task-meta-item">' + due + '</div>' +
          '<div class="task-meta-item">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: <b>' + renderAssignees(task.assignees) + '</b></div>' +
          '<div class="task-meta-item muted">–°–æ–∑–¥–∞–ª: ' + escapeHtml(task.created_by_str || '') + '</div>' +
        '</div>' +
        '<div class="divider"></div>' +
        '<div class="task-detail-actions">' + actionBtns + '</div>' +
        '<div class="divider"></div>' +
        '<div class="task-comments">' +
          '<div class="task-comments-title">–ò—Å—Ç–æ—Ä–∏—è</div>' +
          '<div id="task-events-list">' + renderEvents(task.events) + '</div>' +
        '</div>' +
        '<div class="divider"></div>' +
        '<div class="task-comments">' +
          '<div class="task-comments-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>' +
          '<div id="task-comments-list">' + renderComments(task.comments) + '</div>' +
        '</div>' +
        '<div class="divider"></div>' +
        '<form id="task-comment-form" class="task-form" onsubmit="return window.tasksSubmitComment(event, ' + task.id + ')">' +
          '<div class="task-form-row">' +
            '<div class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>' +
            '<textarea class="form-control" name="text" rows="4" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>' +
          '</div>' +
          '<div class="task-form-row">' +
            '<div class="form-label">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>' +
            '<input class="form-control" type="file" name="photos" accept="image/*" multiple />' +
          '</div>' +
          '<div class="task-modal-footer">' +
            '<button type="button" class="btn-outline" onclick="(' + closeModal.toString() + ')()">–ó–∞–∫—Ä—ã—Ç—å</button>' +
            '<button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>' +
          '</div>' +
        '</form>' +
      '</div>'
    );
    return html;
  }

  async function apiJson(url, opts){
    const o = Object.assign({ credentials: 'include' }, (opts || {}));
    const r = await fetch(url, o);
    if (r.status === 401) {
      try { window.location.href = '/crm/auth/tg'; } catch (_){ }
      throw new Error('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞');
    }
    const data = await r.json().catch(() => ({}));
    if (!r.ok) {
      const msg = (data && (data.detail || data.error)) ? (data.detail || data.error) : ('HTTP ' + r.status);
      throw new Error(msg);
    }
    return data;
  }

  window.tasksOpenCreate = function(){
    const users = JSON.parse((document.getElementById('tasks-users-json') || {}).textContent || '[]');
    const visibleUsers = (users || []).filter(u => {
      if (IS_ADMIN || IS_MANAGER) return true;
      return !(u && (u.is_admin || u.is_manager));
    });
    const html = (
      '<div class="modal-header">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</div>' +
      '<div class="modal-body tasks-modal">' +
        '<form id="task-create-form" class="task-form" onsubmit="return window.tasksSubmitCreate(event)">' +
          '<div class="task-form-row">' +
            '<div class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</div>' +
            '<input class="form-control" type="text" name="title" required />' +
          '</div>' +
          '<div class="task-form-row">' +
            '<div class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>' +
            '<textarea class="form-control" name="description" rows="5"></textarea>' +
          '</div>' +
          '<div class="task-form-grid">' +
            '<div class="task-form-row">' +
              '<div class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>' +
              '<select class="form-control" name="priority"><option value="normal">–û–±—ã—á–Ω–∞—è</option><option value="urgent">–°—Ä–æ—á–Ω–∞—è</option></select>' +
            '</div>' +
            '<div class="task-form-row">' +
              '<div class="form-label">–í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ (–ú–°–ö)</div>' +
              '<input class="form-control" type="datetime-local" name="due_at" />' +
            '</div>' +
          '</div>' +
          '<div class="task-form-row">' +
            '<div class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</div>' +
            '<div class="masters-picker">' +
              '<div class="muted" style="margin-bottom: 6px;">–ú–æ–∂–Ω–æ –Ω–∏–∫–æ–≥–æ ‚Äî –±—É–¥–µ—Ç ¬´–æ–±—â–∞—è¬ª</div>' +
              '<div class="masters-list">' +
                visibleUsers.map(u => (
                  '<label class="masters-row">' +
                    '<input type="checkbox" name="assignee_ids" value="' + u.id + '" />' +
                    '<span>' + escapeHtml((u.first_name||'') + ' ' + (u.last_name||'')) + '</span>' +
                  '</label>'
                )).join('') +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="task-form-row">' +
            '<div class="form-label">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>' +
            '<input class="form-control" type="file" name="photo" accept="image/*" />' +
          '</div>' +
          '<div class="task-modal-footer">' +
            '<button type="button" class="btn-outline" onclick="window.dispatchEvent(new CustomEvent(\'close-modal\'))">–û—Ç–º–µ–Ω–∞</button>' +
            '<button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å</button>' +
          '</div>' +
        '</form>' +
      '</div>'
    );
    openModal(html);
  };

  window.tasksSubmitCreate = async function(ev){
    ev.preventDefault();
    const form = ev.target;
    const fd = new FormData(form);
    try {
      await apiJson('/crm/api/tasks', { method: 'POST', body: fd });
      window.location.reload();
      return false;
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É');
      return false;
    }
  };

  window.tasksOpenDetail = async function(taskId){
    try {
      const task = await apiJson('/crm/api/tasks/' + String(taskId));
      openModal(renderDetailModal(task));
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á—É');
    }
  };

  function toDateTimeLocalFromMskStr(mskStr){
    // mskStr: "DD.MM.YYYY HH:MM"
    try {
      const s = String(mskStr || '').trim();
      if (!s) return '';
      const [dPart, tPart] = s.split(' ');
      if (!dPart || !tPart) return '';
      const [dd, mm, yyyy] = dPart.split('.').map(x => parseInt(x, 10));
      const [hh, mi] = tPart.split(':').map(x => parseInt(x, 10));
      if (!dd || !mm || !yyyy) return '';
      const pad = (n) => String(n).padStart(2, '0');
      return String(yyyy) + '-' + pad(mm) + '-' + pad(dd) + 'T' + pad(hh || 0) + ':' + pad(mi || 0);
    } catch (_){
      return '';
    }
  }

  window.tasksOpenEdit = async function(taskId){
    try {
      const task = await apiJson('/crm/api/tasks/' + String(taskId));
      const users = JSON.parse((document.getElementById('tasks-users-json') || {}).textContent || '[]');
      const visibleUsers = (users || []).filter(u => {
        if (IS_ADMIN || IS_MANAGER) return true;
        return !(u && (u.is_admin || u.is_manager));
      });

      const selectedIds = new Set((task.assignees || []).map(u => String(u.id)));
      const dueVal = task.due_at_str ? toDateTimeLocalFromMskStr(task.due_at_str) : '';
      const hasPhoto = !!(task.photo_url || task.photo_path || task.tg_photo_file_id || task.photo_file_id);

      const html = (
        '<div class="modal-header">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ¬∑ –ó–∞–¥–∞—á–∞ #' + task.id + '</div>' +
        '<div class="modal-body tasks-modal">' +
          '<form id="task-edit-form" class="task-form" onsubmit="return window.tasksSubmitEdit(event, ' + task.id + ')">' +
            '<div class="task-form-row">' +
              '<div class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</div>' +
              '<input class="form-control" type="text" name="title" required value="' + escapeHtml(task.title || '') + '" />' +
            '</div>' +
            '<div class="task-form-row">' +
              '<div class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>' +
              '<textarea class="form-control" name="description" rows="5">' + escapeHtml(task.description || '') + '</textarea>' +
            '</div>' +
            '<div class="task-form-grid">' +
              '<div class="task-form-row">' +
                '<div class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>' +
                '<select class="form-control" name="priority">' +
                  '<option value="normal" ' + (task.priority === 'normal' ? 'selected' : '') + '>–û–±—ã—á–Ω—ã–π</option>' +
                  '<option value="urgent" ' + (task.priority === 'urgent' ? 'selected' : '') + '>–°—Ä–æ—á–Ω–æ</option>' +
                '</select>' +
              '</div>' +
              '<div class="task-form-row">' +
                '<div class="form-label">–î–µ–¥–ª–∞–π–Ω (–ú–°–ö)</div>' +
                '<input class="form-control" type="datetime-local" name="due_at" value="' + escapeHtml(dueVal) + '" />' +
              '</div>' +
            '</div>' +
            '<div class="task-form-row">' +
              '<div class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</div>' +
              '<div class="masters-picker">' +
                '<div class="muted" style="margin-bottom: 6px;">–ú–æ–∂–Ω–æ –Ω–∏–∫–æ–≥–æ ‚Äî –±—É–¥–µ—Ç ¬´–æ–±—â–∞—è¬ª</div>' +
                '<div class="masters-list">' +
                  visibleUsers.map(u => (
                    '<label class="masters-row">' +
                      '<input type="checkbox" name="assignee_ids" value="' + u.id + '" ' + (selectedIds.has(String(u.id)) ? 'checked' : '') + ' />' +
                      '<span>' + escapeHtml(((u.first_name||'') + ' ' + (u.last_name||'')).trim() || ('#' + u.id)) + '</span>' +
                    '</label>'
                  )).join('') +
                '</div>' +
              '</div>' +
            '</div>' +
            '<div class="task-form-row">' +
              '<div class="form-label">–§–æ—Ç–æ</div>' +
              (hasPhoto ? '<div class="muted" style="margin-bottom:6px;">–°–µ–π—á–∞—Å: –µ—Å—Ç—å</div>' : '<div class="muted" style="margin-bottom:6px;">–°–µ–π—á–∞—Å: –Ω–µ—Ç</div>') +
              '<input class="form-control" type="file" name="photo" accept="image/*" />' +
              (hasPhoto ? (
                '<label class="checkbox-row" style="margin-top:10px;">' +
                  '<input type="checkbox" name="remove_photo" value="1" />' +
                  '<span>–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</span>' +
                '</label>'
              ) : '') +
            '</div>' +
            '<div class="task-modal-footer">' +
              '<button type="button" class="btn-outline" onclick="window.tasksOpenDetail(' + task.id + ')">–û—Ç–º–µ–Ω–∞</button>' +
              '<button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>' +
            '</div>' +
          '</form>' +
        '</div>'
      );
      openModal(html);
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ');
    }
  };

  window.tasksSubmitEdit = async function(ev, taskId){
    ev.preventDefault();
    const form = ev.target;
    const fd = new FormData(form);
    const title = String(fd.get('title') || '').trim();
    const description = String(fd.get('description') || '');
    const priority = String(fd.get('priority') || 'normal');
    const dueAt = String(fd.get('due_at') || '').trim();
    const removePhoto = !!fd.get('remove_photo');
    const assigneeIds = (fd.getAll('assignee_ids') || []).map(x => parseInt(String(x), 10)).filter(x => Number.isFinite(x) && x > 0);
    const photo = fd.get('photo');

    try {
      if (removePhoto) {
        await apiJson('/crm/api/tasks/' + String(taskId) + '/photo', { method: 'DELETE' });
      }

      await apiJson('/crm/api/tasks/' + String(taskId), {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title,
          description: description,
          priority: priority,
          due_at: dueAt || null,
          assignee_ids: assigneeIds,
        })
      });

      if (photo && typeof photo === 'object' && photo.size) {
        const up = new FormData();
        up.append('photo', photo);
        await apiJson('/crm/api/tasks/' + String(taskId) + '/photo_web', { method: 'POST', body: up });
      }

      await window.tasksOpenDetail(taskId);
      return false;
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
      return false;
    }
  };

  window.tasksChangeStatus = async function(taskId, status){
    try {
      const resp = await apiJson('/crm/api/tasks/' + String(taskId) + '/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: status })
      });
      window.tasksMoveCard(taskId, resp.status || status);
      // If modal is open, refresh it to update permissions/buttons
      try { await window.tasksOpenDetail(taskId); } catch (_) {}
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
    }
  };

  window.tasksSendBackPrompt = async function(taskId){
    const txt = await window.crmPrompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É):', {
      title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ',
      required: true,
      multiline: true,
      placeholder: '–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–¥–µ–ª–∞—Ç—å‚Ä¶',
      okText: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
      cancelText: '–û—Ç–º–µ–Ω–∞',
      maxLength: 1000,
    });
    if (txt === null) return;
    try {
      const resp = await apiJson('/crm/api/tasks/' + String(taskId) + '/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'in_progress', comment: String(txt) })
      });
      window.tasksMoveCard(taskId, resp.status || 'in_progress');
      try { await window.tasksOpenDetail(taskId); } catch (_) {}
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É');
    }
  };

  window.tasksArchive = async function(taskId){
    const ok = await window.crmConfirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –∞—Ä—Ö–∏–≤?', { title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', danger: true, okText: '–í –∞—Ä—Ö–∏–≤' });
    if (!ok) return;
    try {
      await apiJson('/crm/api/tasks/' + String(taskId) + '/archive', { method: 'POST' });
      window.tasksRemoveCard(taskId);
      window.dispatchEvent(new CustomEvent('close-modal'));
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å');
    }
  };

  function statusColumnId(status){
    return 'col-' + String(status || '');
  }

  function updateColumnCounts(){
    try {
      const cols = document.querySelectorAll('.kanban-col');
      cols.forEach(col => {
        const status = col.getAttribute('data-status');
        const body = document.getElementById(statusColumnId(status));
        const countEl = col.querySelector('.kanban-col-count');
        const emptyEl = body ? body.querySelector('.kanban-empty') : null;
        const cards = body ? body.querySelectorAll('.task-card') : [];
        if (countEl) countEl.textContent = String(cards.length || 0);
        if (emptyEl) {
          emptyEl.style.display = (cards.length ? 'none' : 'block');
        } else if (body && !cards.length) {
          const div = document.createElement('div');
          div.className = 'kanban-empty muted';
          div.textContent = '–ù–µ—Ç –∑–∞–¥–∞—á';
          body.appendChild(div);
        }
      });
    } catch (_) {}
  }

  window.tasksRemoveCard = function(taskId){
    const el = document.querySelector('.task-card[data-task-id="' + String(taskId) + '"]');
    if (el && el.parentElement) {
      el.parentElement.removeChild(el);
      updateColumnCounts();
    }
  };

  window.tasksMoveCard = function(taskId, newStatus){
    const el = document.querySelector('.task-card[data-task-id="' + String(taskId) + '"]');
    const target = document.getElementById(statusColumnId(newStatus));
    if (!el || !target) {
      // fallback: simplest reliable path
      try { window.location.reload(); } catch (_) {}
      return;
    }
    // remove existing empty placeholder in target
    const empty = target.querySelector('.kanban-empty');
    if (empty) empty.style.display = 'none';
    target.prepend(el);
    updateColumnCounts();
  };

  window.tasksSubmitComment = async function(ev, taskId){
    ev.preventDefault();
    const form = ev.target;
    const fd = new FormData(form);
    try {
      const task = await apiJson('/crm/api/tasks/' + String(taskId) + '/comments', { method: 'POST', body: fd });
      // refresh comments in modal without closing
      const list = document.getElementById('task-comments-list');
      if (list) list.innerHTML = renderComments(task.comments);
      form.reset();
      return false;
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
      return false;
    }
  };
})();
</script>
{% endblock %}
