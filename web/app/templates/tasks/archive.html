{% extends base_template %}
{% block title %}–ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á{% endblock %}
{% block content %}
<div class="tasks-header">
  <div>
    <h2 class="subtitle">–ó–∞–¥–∞—á–∏ ¬∑ –ê—Ä—Ö–∏–≤</h2>
    <div class="muted">–ê—Ä—Ö–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</div>
  </div>
  <div class="tasks-header-actions">
    <a class="btn-outline" href="{{ board_url }}">‚Üê –ù–∞ –¥–æ—Å–∫—É</a>
  </div>
</div>

<form class="tasks-filters" method="get" action="{{ archive_url }}">
  <label>
    –ü–æ–∏—Å–∫
    <input type="text" name="q" value="{{ q or '' }}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ" />
  </label>
  <label class="checkbox-row" style="margin-top: 20px;">
    <input type="checkbox" name="mine" value="1" {% if mine %}checked{% endif %} />
    <span>–ú–æ–∏ –∑–∞–¥–∞—á–∏</span>
  </label>
  <label>
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    <select name="priority">
      <option value="" {% if not priority %}selected{% endif %}>–í—Å–µ</option>
      <option value="urgent" {% if priority == 'urgent' %}selected{% endif %}>–°—Ä–æ—á–Ω—ã–µ</option>
      <option value="normal" {% if priority == 'normal' %}selected{% endif %}>–û–±—ã—á–Ω—ã–µ</option>
    </select>
  </label>
  <label>
    –î–µ–¥–ª–∞–π–Ω
    <select name="due">
      <option value="" {% if not due %}selected{% endif %}>–í—Å–µ</option>
      <option value="with_due" {% if due == 'with_due' %}selected{% endif %}>–° –¥–µ–¥–ª–∞–π–Ω–æ–º</option>
      <option value="overdue" {% if due == 'overdue' %}selected{% endif %}>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</option>
    </select>
  </label>
  {% if is_admin or is_manager %}
  <label>
    –°–æ—Ç—Ä—É–¥–Ω–∏–∫
    <select name="assignee_id">
      <option value="" {% if not assignee_id %}selected{% endif %}>–í—Å–µ</option>
      {% for u in users %}
        <option value="{{ u.id }}" {% if assignee_id and (assignee_id == u.id) %}selected{% endif %}>{{ (u.first_name or '') ~ ' ' ~ (u.last_name or '') }}</option>
      {% endfor %}
    </select>
  </label>
  {% endif %}
  <label>
    –°—Ç–∞—Ç—É—Å
    <select name="status">
      <option value="" {% if not status %}selected{% endif %}>–ê—Ä—Ö–∏–≤</option>
      <option value="archived" {% if status == 'archived' %}selected{% endif %}>–ê—Ä—Ö–∏–≤</option>
    </select>
  </label>
  <div class="tasks-filters-actions">
    <button class="btn-outline" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    <a class="btn-outline" href="{{ request.url_for('tasks_archive') }}">–°–±—Ä–æ—Å–∏—Ç—å</a>
  </div>
</form>

<div class="tasks-archive-grid">
  {% for t in items %}
    <div class="task-card {% if t.priority == 'urgent' %}urgent{% endif %}" data-task-id="{{ t.id }}" onclick="window.tasksOpenDetail(this.dataset.taskId)">
      <div class="task-card-top">
        <div class="task-title">{{ t.title }}</div>
        {% if t.priority == 'urgent' %}
          <div class="task-urgent" title="–°—Ä–æ—á–Ω–æ">üî•</div>
        {% endif %}
      </div>
      <div class="task-meta">
        <div class="muted">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ: {{ t.archived_at_str or '' }}</div>
        <div class="task-assignees">
          {% if t.assignees and (t.assignees|length > 0) %}
            <span class="task-assignee-dots-inline" aria-hidden="true">
              {% for a in t.assignees[:3] %}
                {% if a.get('color') %}
                  <span class="task-assignee-dot" title="{{ (a.get('first_name') or '') ~ ' ' ~ (a.get('last_name') or '') }}" style="background: {{ a.get('color') }}"></span>
                {% endif %}
              {% endfor %}
              {% if t.assignees|length > 3 %}
                <span class="task-assignee-more">+{{ (t.assignees|length - 3) }}</span>
              {% endif %}
            </span>
            <span class="task-assignees-text">{{ t.assignees_str }}</span>
          {% else %}
            <span class="muted">–û–±—â–∞—è</span>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
  {% if not items %}
    <div class="muted">–í –∞—Ä—Ö–∏–≤–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.</div>
  {% endif %}
</div>

<script>
(function(){
  const modalBody = () => document.getElementById('modal-body');
  function openModal(html){
    const b = modalBody();
    if (!b) return;
    b.innerHTML = html;
    window.dispatchEvent(new CustomEvent('open-modal'));
  }

  function renderEvents(items){
    if (!items || items.length === 0) {
      return '<div class="muted">–ò—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    }
    return items.map(e => {
      const when = escapeHtml(e.created_at_str || '');
      const who = escapeHtml((e.actor && e.actor.name) ? e.actor.name : '‚Äî');
      const title = escapeHtml(e.title || e.type || '');
      let details = '';
      if (e.type === 'edited') {
        const lines = (e.payload && Array.isArray(e.payload.human)) ? e.payload.human : [];
        if (lines.length) {
          details = '<ul class="muted" style="margin-top:6px; padding-left: 18px;">' +
            lines.map(x => '<li>' + escapeHtml(String(x || '')) + '</li>').join('') +
          '</ul>';
        }
      }
      if (e.type === 'status_changed') {
        const frRaw = (e && (e.from_display || (e.payload && e.payload.from))) || '';
        const toRaw = (e && (e.to_display || (e.payload && e.payload.to))) || '';
        const fr = escapeHtml(frRaw);
        const to = escapeHtml(toRaw);
        details = '<div class="muted" style="margin-top:4px;">' + fr + ' ‚Üí ' + to + '</div>';
      }
      if (e.type === 'comment_added') {
        const hasText = !!(e.payload && e.payload.has_text);
        const pc = (e.payload && typeof e.payload.photos_count === 'number') ? e.payload.photos_count : 0;
        const parts = [];
        if (hasText) parts.push('—Ç–µ–∫—Å—Ç');
        if (pc) parts.push('—Ñ–æ—Ç–æ: ' + String(pc));
        if (parts.length) details = '<div class="muted" style="margin-top:4px;">' + escapeHtml(parts.join(', ')) + '</div>';
      }
      return (
        '<div class="task-comment">' +
          '<div class="task-comment-head">' +
            '<div class="task-comment-author">' + who + ' ¬∑ ' + title + '</div>' +
            '<div class="task-comment-ts muted">' + when + '</div>' +
          '</div>' +
          details +
        '</div>'
      );
    }).join('');
  }
  function escapeHtml(s){
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }
  function renderAssignees(users){
    if (!users || users.length === 0) return '<span class="muted">–û–±—â–∞—è</span>';
    return users.map(u => escapeHtml((u.first_name || '') + ' ' + (u.last_name || '')).trim() || ('#' + u.id)).join(', ');
  }
  function renderComments(items){
    if (!items || items.length === 0) {
      return '<div class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç</div>';
    }
    return items.map(c => {
      const who = escapeHtml((c.author.first_name || '') + ' ' + (c.author.last_name || '')).trim() || ('#' + c.author.id);
      const when = escapeHtml(c.created_at_str || '');
      const text = c.text ? ('<div class="task-comment-text">' + escapeHtml(c.text) + '</div>') : '';
      const photos = (c.photos || []).map(p => (
        '<a href="' + escapeHtml(p.url) + '" target="_blank" rel="noopener">' +
          '<img class="task-photo" src="' + escapeHtml(p.url) + '" alt="photo" />' +
        '</a>'
      )).join('');
      return (
        '<div class="task-comment">' +
          '<div class="task-comment-head">' +
            '<div class="task-comment-author">' + who + '</div>' +
            '<div class="task-comment-ts muted">' + when + '</div>' +
          '</div>' +
          text +
          (photos ? ('<div class="task-photos">' + photos + '</div>') : '') +
        '</div>'
      );
    }).join('');
  }
  function renderDetailModal(task){
    const due = task.due_at_str ? ('<div>–î–µ–¥–ª–∞–π–Ω: <b>' + escapeHtml(task.due_at_str) + '</b></div>') : '<div class="muted">–î–µ–¥–ª–∞–π–Ω: ‚Äî</div>';
    const priority = task.priority === 'urgent' ? '<span class="task-pill urgent">–°—Ä–æ—á–Ω–æ</span>' : '<span class="task-pill">–û–±—ã—á–Ω–æ</span>';
    const statusMap = { new: '–ù–æ–≤—ã–µ', in_progress: '–í —Ä–∞–±–æ—Ç–µ', review: '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', done: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', archived: '–ê—Ä—Ö–∏–≤' };
    const status = '<span class="task-pill">' + escapeHtml(statusMap[task.status] || task.status) + '</span>';
    const can = task.permissions || {};
    const actionBtns = [
      can.unarchive ? '<button class="btn" type="button" onclick="window.tasksUnarchive(' + task.id + ')">–†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>' : '',
      '<button class="btn-outline" type="button" onclick="window.tasksOpenEdit(' + task.id + ')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>'
    ].filter(Boolean).join('');

    const mainPhotoUrl = task.photo_url || task.photo_path;
    const proxyPhotoUrl = (task.tg_photo_file_id || task.photo_file_id) ? ('/crm/tasks/' + task.id + '/photo') : '';
    const effectivePhotoUrl = mainPhotoUrl || proxyPhotoUrl;
    const taskPhoto = effectivePhotoUrl
      ? (
          '<div class="task-main-photo">' +
            '<a href="' + escapeHtml(effectivePhotoUrl) + '" target="_blank" rel="noopener">' +
              '<img class="task-main-photo-img" src="' + escapeHtml(effectivePhotoUrl) + '" alt="task photo" />' +
            '</a>' +
          '</div>'
        )
      : '';

    const html = (
      '<div class="modal-header">–ó–∞–¥–∞—á–∞ #' + task.id + '</div>' +
      '<div class="modal-body">' +
        '<div class="task-detail-head">' +
          '<div class="task-detail-title">' + escapeHtml(task.title) + '</div>' +
          '<div class="task-detail-badges">' + priority + status + '</div>' +
        '</div>' +
        taskPhoto +
        (task.description ? ('<div class="task-detail-desc">' + escapeHtml(task.description) + '</div>') : '<div class="muted">–û–ø–∏—Å–∞–Ω–∏–µ: ‚Äî</div>') +
        '<div class="divider"></div>' +
        '<div class="task-detail-grid">' +
          due +
          '<div>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: <b>' + renderAssignees(task.assignees) + '</b></div>' +
          '<div class="muted">–°–æ–∑–¥–∞–ª: ' + escapeHtml(task.created_by_str || '') + '</div>' +
        '</div>' +
        (actionBtns ? ('<div class="divider"></div><div class="task-detail-actions">' + actionBtns + '</div>') : '') +
        '<div class="divider"></div>' +
        '<div class="task-comments">' +
          '<div class="task-comments-title">–ò—Å—Ç–æ—Ä–∏—è</div>' +
          '<div id="task-events-list">' + renderEvents(task.events) + '</div>' +
        '</div>' +
        '<div class="divider"></div>' +
        '<div class="task-comments">' +
          '<div class="task-comments-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>' +
          '<div id="task-comments-list">' + renderComments(task.comments) + '</div>' +
        '</div>' +
      '</div>'
    );
    return html;
  }
  async function apiJson(url, opts){
    const r = await fetch(url, opts || {});
    const data = await r.json().catch(() => ({}));
    if (!r.ok) {
      const msg = (data && (data.detail || data.error)) ? (data.detail || data.error) : ('HTTP ' + r.status);
      throw new Error(msg);
    }
    return data;
  }

  window.tasksUnarchive = async function(taskId){
    const ok = await window.crmConfirm('–†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É? –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç ¬´–í—ã–ø–æ–ª–Ω–µ–Ω–æ¬ª.', { title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', okText: '–†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å' });
    if (!ok) return;
    try {
      await apiJson('/crm/api/tasks/' + String(taskId) + '/unarchive', { method: 'POST' });
      window.location.reload();
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å');
    }
  };

  window.tasksOpenDetail = async function(taskId){
    try {
      const task = await apiJson('/crm/api/tasks/' + String(taskId));
      openModal(renderDetailModal(task));
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á—É');
    }
  };
})();
</script>
{% endblock %}
