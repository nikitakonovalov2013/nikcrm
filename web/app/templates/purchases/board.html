{% extends base_template %}
{% block body_attrs %}data-crm-page="purchases"{% endblock %}
{% block title %}–ó–∞–∫—É–ø–∫–∏{% endblock %}
{% block content %}
<div class="crm-purchases-page">
<div class="tasks-header">
  <div>
    <h2 class="subtitle">–ó–∞–∫—É–ø–∫–∏</h2>
    <div class="muted">–ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞</div>
  </div>
  <div class="tasks-header-actions">
    <a class="btn-outline" href="{{ archive_url }}">–ê—Ä—Ö–∏–≤ –∑–∞–∫—É–ø–æ–∫</a>
    <button class="btn" type="button" onclick="window.purchasesOpenCreate()">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–∫—É–ø–∫—É</button>
  </div>
</div>

<form class="tasks-filters" method="get" action="{{ board_url or request.url_for('purchases_board') }}">
  <div class="tasks-filters-search">
    <label class="tasks-filter">
      <span class="tasks-filter-label">–ü–æ–∏—Å–∫</span>
      <input type="text" name="q" value="{{ q or '' }}" placeholder="–¢–µ–∫—Å—Ç –∑–∞–∫—É–ø–∫–∏" />
    </label>
  </div>

  <div class="tasks-filters-row">
    <label class="tasks-filter tasks-filter-checkbox">
      <span class="tasks-filter-label">&nbsp;</span>
      <span class="checkbox-row">
        <input type="checkbox" name="mine" value="1" {% if mine %}checked{% endif %} />
        <span>–¢–æ–ª—å–∫–æ –º–æ–∏</span>
      </span>
    </label>

    <div class="tasks-filters-actions">
      <button class="btn-outline" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <a class="btn-outline" href="{{ board_url or request.url_for('purchases_board') }}">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
  </div>
</form>

<div class="kanban">
  {% for col in columns %}
    <section class="kanban-col" data-status="{{ col["status"] }}">
      <div class="kanban-col-header" role="button" tabindex="0" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
        <div class="kanban-col-title">
          <span class="kanban-col-chevron" aria-hidden="true">‚ñæ</span>
          <span class="kanban-col-title-text">{{ col["title"] }}</span>
        </div>
        <div class="kanban-col-count">{{ col.get("items", [])|length }}</div>
      </div>
      <div class="kanban-col-body" id="col-{{ col["status"] }}">
        {% for p in col.get("items", []) %}
          <div class="task-card" data-purchase-id="{{ p.id }}" data-created-at-ts="{{ p.created_at_ts or '' }}" data-status="{{ p.status or '' }}" onclick="window.purchasesOpenDetail(this.dataset.purchaseId)">
            <div class="task-card-top">
              <div class="task-title break-word">{{ p.text }}</div>
              {% if p.photo_url %}
                <img src="{{ p.photo_url }}" alt="" style="width:42px;height:42px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;flex:0 0 auto" loading="lazy" />
              {% endif %}
            </div>

            <div class="task-meta">
              <div class="task-card-meta">
                <div class="task-card-meta-row">
                  <span class="task-card-meta-label">–°–æ–∑–¥–∞–Ω–æ:</span>
                  <span class="task-card-meta-value">{{ p.created_at_str or '‚Äî' }}</span>
                </div>
                <div class="task-card-meta-row">
                  <span class="task-card-meta-label">–°–æ–∑–¥–∞–ª:</span>
                  {% set cb = p.get('creator') %}
                  {% set cb_name = (cb.get('name') if cb else '') or (p.creator_str or '‚Äî') %}
                  {% set cb_color = (cb.get('color') if cb else '') or '#9CA3AF' %}
                  <span class="task-created-by">
                    <span class="task-created-by-dot" style="background: {{ cb_color }}"></span>
                    <span class="task-created-by-name" style="color: {{ cb_color }}" title="{{ cb_name }}">{{ cb_name }}</span>
                  </span>
                </div>
                {% if p.priority %}
                <div class="task-card-meta-row">
                  <span class="task-card-meta-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</span>
                  {% if p.priority == 'urgent' %}
                    <span class="task-card-meta-value" style="font-weight:700;color:#991b1b">üî• –°—Ä–æ—á–Ω–æ</span>
                  {% else %}
                    <span class="task-card-meta-value">–û–±—ã—á–Ω—ã–π</span>
                  {% endif %}
                </div>
                {% endif %}
              </div>

              <div class="purchase-actions">
                {% if col["status"] == 'new' %}
                  <button class="btn-danger" type="button" title="–û—Ç–º–µ–Ω–∏—Ç—å" onclick="event.stopPropagation(); window.purchasesCancel({{ p.id }});">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                  <button class="btn-success" type="button" title="–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É" onclick="event.stopPropagation(); window.purchasesTake({{ p.id }});">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
                {% elif col["status"] == 'in_progress' %}
                  <button class="btn-success" type="button" title="–ö—É–ø–ª–µ–Ω–æ" onclick="event.stopPropagation(); window.purchasesBought({{ p.id }});">–ö—É–ø–ª–µ–Ω–æ</button>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
        {% if not col.get("items") or (col.get("items")|length == 0) %}
          <div class="kanban-empty muted">–ù–µ—Ç –∑–∞–∫—É–ø–æ–∫</div>
        {% endif %}
      </div>
    </section>
  {% endfor %}
</div>

<script>
(function(){
  const COLLAPSED_KEY = 'crm.purchases.board.collapsedCols';

  const IS_ADMIN = {% if is_admin %}true{% else %}false{% endif %};
  const IS_MANAGER = {% if is_manager %}true{% else %}false{% endif %};

  async function apiJson(url, opts){
    const o = Object.assign({ credentials: 'include' }, (opts || {}));
    const r = await fetch(url, o);
    if (r.status === 401) {
      try { window.location.href = '/crm/login'; } catch (_) {}
      throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥');
    }
    const ct = (r.headers.get('content-type') || '').toLowerCase();
    const isJson = ct.includes('application/json');
    if (!r.ok) {
      let msg = '–û—à–∏–±–∫–∞';
      try {
        if (isJson) {
          const data = await r.json();
          msg = (data && (data.detail || data.message)) || msg;
        } else {
          msg = await r.text();
        }
      } catch (_){ }
      throw new Error(msg);
    }
    if (r.status === 204) return null;
    return isJson ? await r.json() : await r.text();
  }

  function _captureKanbanScroll(){
    const m = {};
    try {
      document.querySelectorAll('.kanban-col-body').forEach(el => {
        const id = el && el.id ? String(el.id) : '';
        if (!id) return;
        m[id] = Number(el.scrollTop || 0);
      });
    } catch (_){ }
    return m;
  }

  function _restoreKanbanScroll(map){
    try {
      const m = map || {};
      document.querySelectorAll('.kanban-col-body').forEach(el => {
        const id = el && el.id ? String(el.id) : '';
        if (!id) return;
        const v = m[id];
        if (v === undefined || v === null) return;
        el.scrollTop = Number(v) || 0;
      });
    } catch (_){ }
  }

  async function reloadPurchasesBoardKanban(){
    const prevScroll = _captureKanbanScroll();
    const q = (document.querySelector('input[name="q"]') || {}).value || '';
    const mine = !!((document.querySelector('input[name="mine"]') || {}).checked);

    const params = new URLSearchParams();
    if (String(q || '').trim()) params.set('q', String(q || '').trim());
    if (mine) params.set('mine', '1');

    const url = '/crm/api/purchases' + (String(params) ? ('?' + String(params)) : '');
    const doFetch = (window.crmFetchNoCache && typeof window.crmFetchNoCache === 'function')
      ? window.crmFetchNoCache
      : fetch;
    const r = await doFetch(url, { method: 'GET', credentials: 'same-origin' });
    if (r.status === 401) {
      try { window.location.href = '/crm/login'; } catch (_){ }
      return;
    }
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json().catch(() => ({}));
    const items = (data && Array.isArray(data.items)) ? data.items : [];

    const cols = { new: [], in_progress: [], archived: [] };
    items.forEach(p => {
      const col = kanbanColFromItem(p);
      if (col === 'in_progress') cols.in_progress.push(p);
      else if (col === 'archived') cols.archived.push(p);
      else cols.new.push(p);
    });

    function _renderCol(colKey){
      const body = document.getElementById(statusColumnId(colKey));
      if (!body) return;
      const arr = cols[colKey] || [];
      if (!arr.length) {
        body.innerHTML = '<div class="kanban-empty muted">–ù–µ—Ç –∑–∞–∫—É–ø–æ–∫</div>';
        return;
      }
      body.innerHTML = arr.map(renderPurchaseCard).join('');
    }

    _renderCol('new');
    _renderCol('in_progress');
    _renderCol('archived');

    try { applyCollapsedFromStorage(); } catch (_){ }
    try { bindCollapseHandlers(); } catch (_){ }
    try { updateColumnCounts(); } catch (_){ }
    _restoreKanbanScroll(prevScroll);
  }

  try {
    window.CRM = window.CRM || {};
    window.CRM.reloadPurchasesBoard = reloadPurchasesBoardKanban;
  } catch (_){ }

  function openModal(html){
    const b = document.getElementById('modal-body');
    if (!b) return;
    b.innerHTML = String(html || '');
    window.dispatchEvent(new CustomEvent('open-modal'));
  }

  function statusColumnId(status){
    return 'col-' + String(status || '');
  }

  function kanbanColFromItem(p){
    const st = String((p && p.status) ? p.status : (p && p.getAttribute ? (p.getAttribute('data-status') || '') : ''));
    if (st === 'IN_PROGRESS') return 'in_progress';
    if (st === 'BOUGHT' || st === 'CANCELED') return 'archived';
    return 'new';
  }

  function statusRu(status){
    const s = String(status || '').trim();
    if (s === 'IN_PROGRESS') return '–í —Ä–∞–±–æ—Ç–µ';
    if (s === 'BOUGHT') return '–ö—É–ø–ª–µ–Ω–æ';
    if (s === 'CANCELED') return '–û—Ç–º–µ–Ω–µ–Ω–æ';
    return '–ù–æ–≤—ã–µ';
  }

  function loadCollapsed(){
    try {
      const raw = window.localStorage.getItem(COLLAPSED_KEY);
      if (raw === null) {
        return new Set(['done']);
      }
      const arr = JSON.parse(raw || '[]');
      if (!Array.isArray(arr)) return new Set();
      return new Set(arr.map(x => String(x || '').trim()).filter(Boolean));
    } catch (_){
      return new Set();
    }
  }

  function saveCollapsed(set){
    try {
      const arr = Array.from(set || []).map(x => String(x || '').trim()).filter(Boolean);
      window.localStorage.setItem(COLLAPSED_KEY, JSON.stringify(arr));
    } catch (_){ }
  }

  function applyCollapsedFromStorage(){
    const root = document.querySelector('.kanban');
    if (!root) return;
    const collapsed = loadCollapsed();
    root.querySelectorAll('.kanban-col').forEach(col => {
      const st = String(col.getAttribute('data-status') || '').trim();
      col.classList.toggle('is-collapsed', collapsed.has(st));
    });
  }

  function bindCollapseHandlers(){
    const root = document.querySelector('.kanban');
    if (!root) return;
    root.querySelectorAll('.kanban-col').forEach(col => {
      const header = col.querySelector('.kanban-col-header');
      if (!header) return;
      if (header.dataset.boundCollapse === '1') return;
      header.dataset.boundCollapse = '1';

      const toggle = () => {
        const st = String(col.getAttribute('data-status') || '').trim();
        const collapsed = loadCollapsed();
        const next = !col.classList.contains('is-collapsed');
        col.classList.toggle('is-collapsed', next);
        if (next) collapsed.add(st); else collapsed.delete(st);
        saveCollapsed(collapsed);
      };

      header.addEventListener('click', (ev) => {
        ev.preventDefault();
        toggle();
      });
      header.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          toggle();
        }
      });
    });
  }

  function updateColumnCounts(){
    try {
      const cols = document.querySelectorAll('.kanban-col');
      cols.forEach(col => {
        const status = col.getAttribute('data-status');
        const body = document.getElementById(statusColumnId(status));
        const countEl = col.querySelector('.kanban-col-count');
        const emptyEl = body ? body.querySelector('.kanban-empty') : null;
        const cards = body ? body.querySelectorAll('.task-card') : [];
        if (countEl) countEl.textContent = String(cards.length || 0);
        if (emptyEl) {
          emptyEl.style.display = (cards.length ? 'none' : 'block');
        } else if (body && !cards.length) {
          const div = document.createElement('div');
          div.className = 'kanban-empty muted';
          div.textContent = '–ù–µ—Ç –∑–∞–∫—É–ø–æ–∫';
          body.appendChild(div);
        }
      });
    } catch (_) {}
  }

  function renderPurchaseCard(p){
    const id = (p && p.id) ? String(p.id) : '';
    const createdAtTs = (p && p.created_at_ts) ? String(p.created_at_ts) : '';
    const createdAtStr = (p && p.created_at_str) ? String(p.created_at_str) : '';
    const text = (p && p.text) ? String(p.text) : '';
    const creator = (p && p.creator) ? p.creator : null;
    const creatorStr = (creator && creator.name) ? String(creator.name) : ((p && p.creator_str) ? String(p.creator_str) : '‚Äî');
    const creatorColor = (creator && creator.color) ? String(creator.color) : '#9CA3AF';
    const pr = (p && p.priority) ? String(p.priority) : '';
    const photoUrl = (p && p.photo_url) ? String(p.photo_url) : '';
    const st = (p && p.status) ? String(p.status) : '';
    const col = kanbanColFromItem(p);
    return (
      '<div class="task-card" data-purchase-id="' + esc(id) + '" data-created-at-ts="' + esc(createdAtTs) + '" data-status="' + esc(st) + '" onclick="window.purchasesOpenDetail(this.dataset.purchaseId)">' +
        '<div class="task-card-top">' +
          '<div class="task-title break-word">' + esc(text) + '</div>' +
          (photoUrl ? ('<img src="' + esc(photoUrl) + '" alt="" style="width:42px;height:42px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;flex:0 0 auto" loading="lazy" />') : '') +
        '</div>' +
        '<div class="task-meta">' +
          '<div class="task-card-meta">' +
            '<div class="task-card-meta-row"><span class="task-card-meta-label">–°–æ–∑–¥–∞–Ω–æ:</span><span class="task-card-meta-value">' + esc(createdAtStr) + '</span></div>' +
            '<div class="task-card-meta-row"><span class="task-card-meta-label">–°–æ–∑–¥–∞–ª:</span>' +
              '<span class="task-created-by">' +
                '<span class="task-created-by-dot" style="background:' + esc(creatorColor) + '"></span>' +
                '<span class="task-created-by-name" style="color:' + esc(creatorColor) + '" title="' + esc(creatorStr) + '">' + esc(creatorStr) + '</span>' +
              '</span>' +
            '</div>' +
            (pr ? ('<div class="task-card-meta-row"><span class="task-card-meta-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</span><span class="task-card-meta-value"' + (pr === 'urgent' ? ' style="font-weight:700;color:#991b1b"' : '') + '>' + (pr === 'urgent' ? 'üî• –°—Ä–æ—á–Ω–æ' : '–û–±—ã—á–Ω—ã–π') + '</span></div>') : '') +
          '</div>' +
          '<div class="purchase-actions">' +
            (col === 'new'
              ? (
                  '<button class="btn-danger" type="button" title="–û—Ç–º–µ–Ω–∏—Ç—å" onclick="event.stopPropagation(); window.purchasesCancel(' + esc(id) + ');">–û—Ç–º–µ–Ω–∏—Ç—å</button>' +
                  '<button class="btn-success" type="button" title="–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É" onclick="event.stopPropagation(); window.purchasesTake(' + esc(id) + ');">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>'
                )
              : (col === 'in_progress'
                  ? '<button class="btn-success" type="button" title="–ö—É–ø–ª–µ–Ω–æ" onclick="event.stopPropagation(); window.purchasesBought(' + esc(id) + ');">–ö—É–ø–ª–µ–Ω–æ</button>'
                  : ''
                )
            ) +
          '</div>' +
        '</div>' +
      '</div>'
    );
  }

  window.purchasesUpsertCard = function(purchase){
    try {
      const id = purchase && purchase.id ? String(purchase.id) : '';
      if (!id) return;
      const existing = document.querySelector('.task-card[data-purchase-id="' + id + '"]');
      if (existing && existing.parentElement) {
        const wrap = document.createElement('div');
        wrap.innerHTML = renderPurchaseCard(purchase);
        const el = wrap.firstChild;
        existing.parentElement.replaceChild(el, existing);
      }
      updateColumnCounts();
    } catch (_) {}
  };

  window.purchasesRemoveCard = function(purchaseId){
    const el = document.querySelector('.task-card[data-purchase-id="' + String(purchaseId) + '"]');
    if (el && el.parentElement) {
      el.parentElement.removeChild(el);
      updateColumnCounts();
    }
  };

  window.purchasesMoveCard = function(purchaseId, newColStatus){
    const el = document.querySelector('.task-card[data-purchase-id="' + String(purchaseId) + '"]');
    const target = document.getElementById(statusColumnId(newColStatus));
    if (!el || !target) {
      updateColumnCounts();
      return;
    }
    const empty = target.querySelector('.kanban-empty');
    if (empty) empty.style.display = 'none';
    target.appendChild(el);
    updateColumnCounts();
  };

  function esc(s){
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function renderEvents(events){
    const items = Array.isArray(events) ? events : [];
    if (!items.length) return '<div class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
    return items.map(e => {
      const who = (e.actor && e.actor.name) ? e.actor.name : '‚Äî';
      const txt = e.text ? ('<div style="white-space:pre-wrap;">' + esc(e.text) + '</div>') : '';
      const typ = esc(e.type_ru || e.type || '');
      return (
        '<div style="padding:10px 0; border-bottom:1px solid rgba(0,0,0,0.06);">' +
          '<div style="display:flex; gap:8px; flex-wrap:wrap; align-items:baseline;">' +
            '<div style="font-weight:600;">' + typ + '</div>' +
            '<div class="muted">' + esc(e.created_at_str || '') + '</div>' +
          '</div>' +
          '<div class="muted">' + esc(who) + '</div>' +
          txt +
        '</div>'
      );
    }).join('');
  }

  function renderDetailModal(p){
    const perms = (p && p.permissions) ? p.permissions : {};
    const canComment = !!perms.comment;
    const canCancel = !!perms.cancel;
    const canTake = !!perms.take;
    const canBought = !!perms.bought;
    const photoUrl = (p && p.photo_url) ? String(p.photo_url) : '';

    const creator = (p && p.creator) ? p.creator : null;
    const creatorStr = (creator && creator.name) ? String(creator.name) : '‚Äî';
    const creatorColor = (creator && creator.color) ? String(creator.color) : '#9CA3AF';
    const takenBy = (p && p.taken_by) ? p.taken_by : null;
    const takenByStr = (takenBy && takenBy.name) ? String(takenBy.name) : '';
    const takenByColor = (takenBy && takenBy.color) ? String(takenBy.color) : '#9CA3AF';
    const boughtBy = (p && p.bought_by) ? p.bought_by : null;
    const boughtByStr = (boughtBy && boughtBy.name) ? String(boughtBy.name) : '';
    const boughtByColor = (boughtBy && boughtBy.color) ? String(boughtBy.color) : '#9CA3AF';
    const archivedBy = (p && p.archived_by) ? p.archived_by : null;
    const archivedByStr = (archivedBy && archivedBy.name) ? String(archivedBy.name) : '';
    const archivedByColor = (archivedBy && archivedBy.color) ? String(archivedBy.color) : '#9CA3AF';
    const pr = (p && p.priority) ? String(p.priority) : '';
    const prLabel = (pr === 'urgent') ? 'üî• –°—Ä–æ—á–Ω–æ' : '–û–±—ã—á–Ω—ã–π';
    const prStyle = (pr === 'urgent') ? ' style="font-weight:700;color:#991b1b"' : '';

    return (
      '<div class="task-modal">' +
        '<div class="task-modal-head">' +
          '<div>' +
            '<div class="task-modal-title">–ó–∞–∫—É–ø–∫–∞ #' + esc(p.id) + '</div>' +
          '</div>' +
        '</div>' +

        '<div style="display:flex; flex-direction:column; gap:10px;">' +
          '<div>' +
            '<div class="muted" style="margin-bottom:6px;">–ó–∞–ø—Ä–æ—Å</div>' +
            '<div style="white-space:pre-wrap;">' + esc(p.text || '') + '</div>' +
          '</div>' +

          '<div class="task-detail-grid">' +
            '<div class="card-row"><span class="card-row-label">–ö—Ç–æ —Å–æ–∑–¥–∞–ª</span><span class="card-row-value">' +
              '<span class="task-created-by">' +
                '<span class="task-created-by-dot" style="background:' + esc(creatorColor) + '"></span>' +
                '<span class="task-created-by-name" style="color:' + esc(creatorColor) + '" title="' + esc(creatorStr) + '">' + esc(creatorStr) + '</span>' +
              '</span>' +
            '</span></div>' +
            (takenByStr
              ? ('<div class="card-row"><span class="card-row-label">–í–∑—è–ª –≤ —Ä–∞–±–æ—Ç—É</span><span class="card-row-value">' +
                  '<span class="task-created-by">' +
                    '<span class="task-created-by-dot" style="background:' + esc(takenByColor) + '"></span>' +
                    '<span class="task-created-by-name" style="color:' + esc(takenByColor) + '" title="' + esc(takenByStr) + '">' + esc(takenByStr) + '</span>' +
                  '</span>' +
                '</span></div>')
              : ''
            ) +
            (boughtByStr
              ? ('<div class="card-row"><span class="card-row-label">–ö—É–ø–∏–ª</span><span class="card-row-value">' +
                  '<span class="task-created-by">' +
                    '<span class="task-created-by-dot" style="background:' + esc(boughtByColor) + '"></span>' +
                    '<span class="task-created-by-name" style="color:' + esc(boughtByColor) + '" title="' + esc(boughtByStr) + '">' + esc(boughtByStr) + '</span>' +
                  '</span>' +
                '</span></div>')
              : ''
            ) +
            (archivedByStr
              ? ('<div class="card-row"><span class="card-row-label">–ó–∞–∫—Ä—ã–ª</span><span class="card-row-value">' +
                  '<span class="task-created-by">' +
                    '<span class="task-created-by-dot" style="background:' + esc(archivedByColor) + '"></span>' +
                    '<span class="task-created-by-name" style="color:' + esc(archivedByColor) + '" title="' + esc(archivedByStr) + '">' + esc(archivedByStr) + '</span>' +
                  '</span>' +
                '</span></div>')
              : ''
            ) +
            '<div class="card-row"><span class="card-row-label">–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–ª</span><span class="card-row-value">' + esc(p.created_at_str || '‚Äî') + '</span></div>' +
            '<div class="card-row"><span class="card-row-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span><span class="card-row-value"' + prStyle + '>' + esc(prLabel) + '</span></div>' +
          '</div>' +

          '<div>' +
            '<div class="muted" style="margin-bottom:6px;">–§–æ—Ç–æ</div>' +
            (photoUrl ? ('<div class="task-main-photo"><img class="task-main-photo-img" src="' + esc(photoUrl) + '" alt="" /></div>') : '<div class="muted">‚Äî</div>') +
          '</div>' +

          '<div class="divider"></div>' +
          '<div class="task-comments">' +
            '<div class="task-comments-title">–ò—Å—Ç–æ—Ä–∏—è</div>' +
            '<div id="purchase-events-list">' + renderEvents(p.events) + '</div>' +
          '</div>' +
          '<div class="divider"></div>' +

          (canComment
            ? '<form class="purchase-comment-form" onsubmit="return window.purchasesSubmitComment(event,' + esc(p.id) + ')">' +
                '<div class="task-comments">' +
                  '<div class="task-comments-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>' +
                  '<textarea name="text" class="input" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" required></textarea>' +
                '</div>' +
                '<div class="purchase-comment-form-actions">' +
                  '<button class="btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>' +
                '</div>' +
              '</form>'
            : ''
          ) +

          '<div class="divider"></div>' +
          '<div class="purchase-actions">' +
            (canCancel ? '<button class="btn-danger" type="button" onclick="window.purchasesCancel(' + esc(p.id) + ')">–û—Ç–º–µ–Ω–∏—Ç—å</button>' : '') +
            (canTake ? '<button class="btn-success" type="button" onclick="window.purchasesTake(' + esc(p.id) + ')">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>' : '') +
            (canBought ? '<button class="btn-success" type="button" onclick="window.purchasesBought(' + esc(p.id) + ')">–ö—É–ø–ª–µ–Ω–æ</button>' : '') +
          '</div>' +
        '</div>' +
      '</div>'
    );
  }

  window.purchasesOpenCreate = function(){
    openModal(
      '<div class="task-modal">' +
        '<div class="task-modal-head">' +
          '<div>' +
            '<div class="task-modal-title">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫—É–ø–∫—É</div>' +
            '<div class="muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</div>' +
          '</div>' +
        '</div>' +
        '<form onsubmit="return window.purchasesSubmitCreate(event)">' +
          '<div style="display:flex; flex-direction:column; gap:12px;">' +
            '<div>' +
              '<div class="muted" style="margin-bottom:6px;">–û–ø–∏—Å–∞–Ω–∏–µ / –ß—Ç–æ –∫—É–ø–∏—Ç—å</div>' +
              '<textarea id="purchase-create-text" name="text" class="input" rows="4" required style="width:100%;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ä—á–∞—Ç–∫–∏ –Ω–∏—Ç—Ä–∏–ª–æ–≤—ã–µ, 100 —à—Ç, —Ä–∞–∑–º–µ—Ä M"></textarea>' +
            '</div>' +
            '<div>' +
              '<div class="muted" style="margin-bottom:6px;">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>' +
              '<select id="purchase-create-priority" name="priority" class="input" style="width:100%;">' +
                '<option value="normal" selected>–û–±—ã—á–Ω—ã–π</option>' +
                '<option value="urgent">–°—Ä–æ—á–Ω–æ</option>' +
              '</select>' +
            '</div>' +
            '<div>' +
              '<div class="muted" style="margin-bottom:6px;">–§–æ—Ç–æ</div>' +
              '<input id="purchase-create-photo" name="photo" type="file" accept="image/*" />' +
            '</div>' +
            '<div class="purchase-form-actions">' +
              '<button id="purchase-create-submit" class="btn" type="submit">–°–æ–∑–¥–∞—Ç—å</button>' +
            '</div>' +
          '</div>' +
        '</form>' +
      '</div>'
    );
  };

  window.purchasesSubmitCreate = async function(ev){
    ev.preventDefault();
    const form = ev.target;
    const fd = new FormData(form);
    try {
      const inp = document.getElementById('purchase-create-photo');
      const file = inp && inp.files ? inp.files[0] : null;
      if (!file || !file.size || file.size <= 0) {
        fd.delete('photo');
      } else {
        fd.set('photo', file);
      }
    } catch (_){ }
    try {
      const resp = await apiJson('/crm/api/purchases', { method: 'POST', body: fd });
      const id = resp && resp.id ? resp.id : null;
      if (!id) {
        window.dispatchEvent(new CustomEvent('close-modal'));
        try { await reloadPurchasesBoardKanban(); } catch (_){ }
        return false;
      }

      window.dispatchEvent(new CustomEvent('close-modal'));
      try {
        const detail = await apiJson('/crm/api/purchases/' + String(id));
        const col = kanbanColFromItem(detail);
        const target = document.getElementById(statusColumnId(col));
        if (target) {
          const wrap = document.createElement('div');
          wrap.innerHTML = renderPurchaseCard(Object.assign({}, detail, { creator_str: (detail.creator && detail.creator.name) ? detail.creator.name : '‚Äî' }));
          const el = wrap.firstChild;
          target.insertBefore(el, target.firstChild);
          updateColumnCounts();
        } else {
          try { await reloadPurchasesBoardKanban(); } catch (_){ }
        }
      } catch (_){ try { await reloadPurchasesBoardKanban(); } catch (__){ } }
      return false;
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫—É–ø–∫—É');
      return false;
    }
  };

  window.purchasesOpenDetail = async function(purchaseId){
    try {
      const p = await apiJson('/crm/api/purchases/' + String(purchaseId));
      openModal(renderDetailModal(p));
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫—É–ø–∫—É');
    }
  };


  window.purchasesSubmitComment = async function(ev, purchaseId){
    ev.preventDefault();
    const form = ev.target;
    const fd = new FormData(form);
    try {
      await apiJson('/crm/api/purchases/' + String(purchaseId) + '/comment', { method: 'POST', body: fd });
      await window.purchasesOpenDetail(purchaseId);
      return false;
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
      return false;
    }
  };

  async function refetchAndSync(purchaseId){
    const p = await apiJson('/crm/api/purchases/' + String(purchaseId));
    const col = kanbanColFromItem(p);
    window.purchasesUpsertCard(p);
    if (col === 'archived') {
      window.purchasesRemoveCard(purchaseId);
    } else {
      window.purchasesMoveCard(purchaseId, col);
    }
    return p;
  }

  window.purchasesCancel = async function(purchaseId){
    const ok = await window.crmConfirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫—É–ø–∫—É?', { title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', danger: true, okText: '–û—Ç–º–µ–Ω–∏—Ç—å' });
    if (!ok) return;
    try {
      await apiJson('/crm/api/purchases/' + String(purchaseId) + '/cancel', { method: 'POST' });
      await refetchAndSync(purchaseId);
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å');
    }
  };

  window.purchasesTake = async function(purchaseId){
    const ok = await window.crmConfirm('–í–∑—è—Ç—å –∑–∞–∫—É–ø–∫—É –≤ —Ä–∞–±–æ—Ç—É?', { title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', okText: '–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É' });
    if (!ok) return;
    try {
      await apiJson('/crm/api/purchases/' + String(purchaseId) + '/take', { method: 'POST' });
      await refetchAndSync(purchaseId);
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É');
    }
  };

  window.purchasesBought = async function(purchaseId){
    const ok = await window.crmConfirm('–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∫—É–ø–ª–µ–Ω–æ?', { title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ', okText: '–ö—É–ø–ª–µ–Ω–æ' });
    if (!ok) return;
    try {
      await apiJson('/crm/api/purchases/' + String(purchaseId) + '/bought', { method: 'POST' });
      await refetchAndSync(purchaseId);
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∫—É–ø–ª–µ–Ω–æ');
    }
  };

  try {
    applyCollapsedFromStorage();
    bindCollapseHandlers();
    updateColumnCounts();
  } catch (_){ }
})();
</script>
</div>
{% endblock %}
