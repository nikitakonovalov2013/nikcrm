{% extends base_template %}
{% block title %}–ê—Ä—Ö–∏–≤ –∑–∞–∫—É–ø–æ–∫{% endblock %}
{% block content %}
<div class="tasks-header">
  <div>
    <h2 class="subtitle">–ó–∞–∫—É–ø–∫–∏ ¬∑ –ê—Ä—Ö–∏–≤</h2>
    <div class="muted">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏</div>
  </div>
  <div class="tasks-header-actions">
    <a class="btn-outline" href="{{ board_url }}">‚Üê –ù–∞ –¥–æ—Å–∫—É</a>
  </div>
</div>

<form class="tasks-filters" method="get" action="{{ archive_url }}">
  <div class="tasks-filters-search">
    <label class="tasks-filter">
      <span class="tasks-filter-label">–ü–æ–∏—Å–∫</span>
      <input type="text" name="q" value="{{ q or '' }}" placeholder="–¢–µ–∫—Å—Ç –∑–∞–∫—É–ø–∫–∏" />
    </label>
  </div>

  <div class="tasks-filters-row">
    <div class="tasks-filters-actions">
      <button class="btn-outline" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <a class="btn-outline" href="{{ archive_url }}">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
  </div>
</form>

<div class="tasks-archive-grid">
  {% for p in items %}
    <div class="task-card" data-purchase-id="{{ p.id }}" onclick="window.purchasesArchiveOpenDetail(this.dataset.purchaseId)">
      <div class="task-card-top">
        <div class="task-title break-word">{{ p.text }}</div>
        {% if p.photo_url %}
          <img src="{{ p.photo_url }}" alt="" style="width:42px;height:42px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;flex:0 0 auto" loading="lazy" />
        {% endif %}
      </div>
      <div class="task-meta">
        <div class="task-card-meta">
          <div class="task-card-meta-row">
            <span class="task-card-meta-label">–°–æ–∑–¥–∞–Ω–æ:</span>
            <span class="task-card-meta-value">{{ p.created_at_str or '‚Äî' }}</span>
          </div>
          <div class="task-card-meta-row">
            <span class="task-card-meta-label">–°–æ–∑–¥–∞—Ç–µ–ª—å:</span>
            <span class="task-card-meta-value break-word">{{ p.creator_str or '‚Äî' }}</span>
          </div>
          {% if p.priority %}
          <div class="task-card-meta-row">
            <span class="task-card-meta-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</span>
            {% if p.priority == 'urgent' %}
              <span class="task-card-meta-value" style="font-weight:700;color:#991b1b">üî• –°—Ä–æ—á–Ω–æ</span>
            {% else %}
              <span class="task-card-meta-value">–û–±—ã—á–Ω—ã–π</span>
            {% endif %}
          </div>
          {% endif %}
          <div class="task-card-meta-row">
            <span class="task-card-meta-label">–°—Ç–∞—Ç—É—Å:</span>
            {% if p.status == 'BOUGHT' %}
              <span class="task-card-meta-value">–ö—É–ø–ª–µ–Ω–æ</span>
            {% elif p.status == 'CANCELED' %}
              <span class="task-card-meta-value">–û—Ç–º–µ–Ω–µ–Ω–æ</span>
            {% else %}
              <span class="task-card-meta-value">‚Äî</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  {% if not items %}
    <div class="muted">–í –∞—Ä—Ö–∏–≤–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫—É–ø–æ–∫.</div>
  {% endif %}
</div>

<script>
(function(){
  async function apiJson(url, opts){
    const o = Object.assign({ credentials: 'include' }, (opts || {}));
    const r = await fetch(url, o);
    if (r.status === 401) {
      try { window.location.href = '/crm/login'; } catch (_) {}
      throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥');
    }
    const ct = (r.headers.get('content-type') || '').toLowerCase();
    const isJson = ct.includes('application/json');
    if (!r.ok) {
      let msg = '–û—à–∏–±–∫–∞';
      try {
        if (isJson) {
          const data = await r.json();
          msg = (data && (data.detail || data.message)) || msg;
        } else {
          msg = await r.text();
        }
      } catch (_){ }
      throw new Error(msg);
    }
    if (r.status === 204) return null;
    return isJson ? await r.json() : await r.text();
  }

  function openModal(html){
    const b = document.getElementById('modal-body');
    if (!b) return;
    b.innerHTML = String(html || '');
    window.dispatchEvent(new CustomEvent('open-modal'));
  }

  function esc(s){
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function renderEvents(events){
    const items = Array.isArray(events) ? events : [];
    if (!items.length) return '<div class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';

    const typeRu = (t) => {
      const s = String(t || '');
      if (s === 'created') return '–°–æ–∑–¥–∞–Ω–æ';
      if (s === 'taken') return '–í–∑—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É';
      if (s === 'bought') return '–ö—É–ø–ª–µ–Ω–æ';
      if (s === 'canceled') return '–û—Ç–º–µ–Ω–µ–Ω–æ';
      if (s === 'comment') return '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
      if (s === 'edited') return '–ò–∑–º–µ–Ω–µ–Ω–æ';
      if (s === 'photo_added') return '–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ';
      if (s === 'photo_replaced') return '–§–æ—Ç–æ –∑–∞–º–µ–Ω–µ–Ω–æ';
      if (s === 'photo_removed') return '–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ';
      if (s === 'archived') return '–ó–∞–∫—Ä—ã—Ç–æ';
      if (s === 'unarchived') return '–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –∏–∑ –∞—Ä—Ö–∏–≤–∞';
      return s || '‚Äî';
    };

    return items.map(e => {
      const who = (e.actor && e.actor.name) ? e.actor.name : '‚Äî';
      const txt = e.text ? ('<div style="white-space:pre-wrap;">' + esc(e.text) + '</div>') : '';
      const typ = esc(typeRu(e.type));
      return (
        '<div style="padding:10px 0; border-bottom:1px solid rgba(0,0,0,0.06);">' +
          '<div style="display:flex; gap:8px; flex-wrap:wrap; align-items:baseline;">' +
            '<div style="font-weight:600;">' + typ + '</div>' +
            '<div class="muted">' + esc(e.created_at_str || '') + '</div>' +
          '</div>' +
          '<div class="muted">' + esc(who) + '</div>' +
          txt +
        '</div>'
      );
    }).join('');
  }

  function renderDetailModal(p){
    const photoUrl = (p && p.photo_url) ? String(p.photo_url) : '';
    const st = String((p && p.status) ? p.status : '');
    const stRu = (st === 'BOUGHT') ? '–ö—É–ø–ª–µ–Ω–æ' : ((st === 'CANCELED') ? '–û—Ç–º–µ–Ω–µ–Ω–æ' : '‚Äî');
    return (
      '<div class="task-modal">' +
        '<div class="task-modal-head">' +
          '<div>' +
            '<div class="task-modal-title">–ó–∞–∫—É–ø–∫–∞ #' + esc(p.id) + '</div>' +
            '<div class="muted">–°–æ–∑–¥–∞–Ω–æ: ' + esc(p.created_at_str || '') + '</div>' +
          '</div>' +
        '</div>' +
        '<div style="display:flex; flex-direction:column; gap:10px;">' +
          '<div>' +
            '<div class="muted" style="margin-bottom:6px;">–¢–µ–∫—Å—Ç</div>' +
            '<div style="white-space:pre-wrap;">' + esc(p.text || '') + '</div>' +
          '</div>' +
          '<div class="task-detail-grid">' +
            '<div class="card-row"><span class="card-row-label">–°—Ç–∞—Ç—É—Å</span><span class="card-row-value">' + esc(stRu) + '</span></div>' +
          '</div>' +
          '<div>' +
            '<div class="muted" style="margin-bottom:6px;">–§–æ—Ç–æ</div>' +
            (photoUrl ? ('<div class="task-main-photo"><img class="task-main-photo-img" src="' + esc(photoUrl) + '" alt="" /></div>') : '<div class="muted">‚Äî</div>') +
          '</div>' +
          '<div>' +
            '<div class="muted" style="margin-bottom:6px;">–ò—Å—Ç–æ—Ä–∏—è</div>' +
            '<div>' + renderEvents(p.events) + '</div>' +
          '</div>' +
        '</div>' +
      '</div>'
    );
  }

  window.purchasesArchiveOpenDetail = async function(purchaseId){
    try {
      const p = await apiJson('/crm/api/purchases/' + String(purchaseId));
      openModal(renderDetailModal(p));
    } catch (e) {
      await window.crmAlert((e && e.message) || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫—É–ø–∫—É');
    }
  };
})();
</script>
{% endblock %}
