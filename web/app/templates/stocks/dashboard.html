{% extends "base.html" %}
{% block title %}Остатки — Дашборд{% endblock %}
{% block content %}
<h2 class="subtitle">Остатки · Дашборд</h2>

<form class="filters" method="get" action="{{ url_for('stocks_dashboard') }}">
  <div class="filters-grid">
    <label>
      Дата с
      <input type="date" name="date_from" value="{{ date_from }}" />
    </label>
    <label>
      Дата по
      <input type="date" name="date_to" value="{{ date_to }}" />
    </label>
    <div class="filters-actions">
      <button class="btn" type="submit">Показать</button>
    </div>
  </div>
</form>

<div class="dashboard-grid dashboard-top">
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">Общая статистика расходов/приходов</div>
      <div class="muted">за период</div>
    </div>
    <div class="panel-body chart-body">
      <canvas id="barChart" height="180"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">История</div>
      <div class="muted">последние события</div>
    </div>
    <div class="panel-body history-body">
      <div class="history-scroll">
        <div class="history">
        {% for h in history %}
          <div class="history-item">
            <div class="history-top">
              <span class="history-kind {{ 'in' if h.kind == 'in' else 'out' }}">{{ 'Приход' if h.kind == 'in' else 'Расход' }}</span>
              <span class="history-ts">{{ h.ts_str }}</span>
            </div>
            <div class="history-main">
              <span class="history-material">{{ h.material_name }}</span>
              <span class="history-amount">{{ h.amount }}</span>
            </div>
            <div class="muted">
              {% if h.actor_color %}
                <span class="user-dot" style="background: {{ h.actor_color }}"></span>
              {% endif %}
              <span style="color: {{ h.actor_color if h.actor_color else '#334155' }}">{{ h.actor_name if h.actor_name else '—' }}</span>
              {% if h.actor_tg_id %}
                (TG: #{{ h.actor_tg_id }})
              {% endif %}
            </div>
          </div>
        {% endfor %}
        {% if history|length == 0 %}
          <div class="muted">Нет данных за выбранный период.</div>
        {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="dashboard-grid bottom">
  <div class="panel-stack">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Остатки на складе</div>
        <div class="muted">распределение</div>
      </div>
      <div class="panel-body">
        <canvas id="pieChart" height="220"></canvas>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Кто сколько расходовал материала</div>
        <div class="muted">за период</div>
      </div>
      <div class="panel-body chart-body" style="min-height:260px">
        <div id="mastersEmpty" class="muted" style="display:none">Нет данных за выбранный период.</div>
        <canvas id="mastersChart" height="220"></canvas>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">Остатки и прогноз</div>
      <div class="muted">средний расход за 4 дня</div>
    </div>
    <div class="panel-body" style="padding:0">
      <div class="table-wrap" style="border:none; border-radius:0">
        <table class="table crm-table" id="stocks-forecast-table">
          <thead>
            <tr>
              <th>Материал</th>
              <th>Текущий остаток</th>
              <th>Средний расход/день</th>
              <th>Прогноз (дней)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in stock_rows %}
              <tr class="{{ 'low-stock' if r.is_low else '' }}">
                <td data-label="Материал" class="crm-field"><span class="crm-value">{{ r.material_name }}</span></td>
                <td data-label="Текущий остаток" class="crm-field"><span class="crm-value crm-nowrap">{{ r.current_stock_str }}</span></td>
                <td data-label="Средний расход/день" class="crm-field"><span class="crm-value crm-nowrap">{{ r.avg_daily_out_str }}</span></td>
                <td data-label="Прогноз (дней)" class="crm-field"><span class="crm-value crm-nowrap">
                  {% if r.forecast_days is none %}
                    —
                  {% else %}
                    <span class="badge {{ 'REJECTED' if r.is_low else 'APPROVED' }}">{{ r.forecast_days }}</span>
                  {% endif %}
                </span></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="application/json" id="chart-data">{{ chart_json | safe }}</script>
<script type="application/json" id="pie-data">{{ pie_json | safe }}</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  function parseJsonScript(id) {
    const el = document.getElementById(id);
    if (!el) return [];
    try {
      return JSON.parse(el.textContent || '[]');
    } catch (e) {
      console.error('[stocks-dashboard] failed to parse json', id, e);
      return [];
    }
  }

  function initCharts() {
    const chartRows = parseJsonScript('chart-data');
    const pieRows = parseJsonScript('pie-data');

    const labels = chartRows.map(r => r.material_name);
    const inData = chartRows.map(r => Number(r.total_in));
    const outData = chartRows.map(r => Number(r.total_out));

    const barEl = document.getElementById('barChart');
    const pieEl = document.getElementById('pieChart');
    const mastersEl = document.getElementById('mastersChart');
    const mastersEmptyEl = document.getElementById('mastersEmpty');
    if (!barEl || !pieEl || !window.Chart) return;

    const barChart = new Chart(barEl, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Приход', data: inData, backgroundColor: 'rgba(37, 99, 235, 0.75)' },
          { label: 'Расход', data: outData, backgroundColor: 'rgba(239, 68, 68, 0.75)' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        scales: {
          x: { stacked: false },
          y: { beginAtZero: true }
        }
      }
    });

    const pieLabels = pieRows.map(r => r.label);
    const pieValues = pieRows.map(r => Number(r.value));

    const pieChart = new Chart(pieEl, {
      type: 'doughnut',
      data: {
        labels: pieLabels,
        datasets: [{
          data: pieValues,
          backgroundColor: [
            '#2563eb','#0ea5e9','#22c55e','#f59e0b','#ef4444','#a855f7','#14b8a6','#64748b','#e11d48','#84cc16'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });

    // After flex/grid layout settles, force Chart.js to measure containers.
    requestAnimationFrame(() => {
      try {
        barChart.resize();
        barChart.update();
        pieChart.resize();
        pieChart.update();
      } catch (_) {}
      try { window.dispatchEvent(new Event('resize')); } catch (_) {}
    });

    async function loadMastersChart() {
      if (!mastersEl) return;
      try {
        const df = (document.querySelector('input[name="date_from"]') || {}).value || '';
        const dt = (document.querySelector('input[name="date_to"]') || {}).value || '';
        const path = (window.location && window.location.pathname) ? String(window.location.pathname) : '';
        const basePrefix = path.startsWith('/crm/') ? '/crm' : '';
        const url = basePrefix + '/api/stocks/cast-by-masters?date_from=' + encodeURIComponent(df) + '&date_to=' + encodeURIComponent(dt);
        const resp = await fetch(url, { credentials: 'same-origin' });
        const ct = (resp.headers && resp.headers.get) ? (resp.headers.get('content-type') || '') : '';
        if (!resp.ok) {
          const txt = await resp.text();
          console.error('[stocks-dashboard] masters api failed', resp.status, ct, (txt || '').slice(0, 200));
          throw new Error('HTTP ' + resp.status);
        }
        let data;
        try {
          data = await resp.json();
        } catch (e) {
          const txt = await resp.text();
          console.error('[stocks-dashboard] masters api bad json', resp.status, ct, (txt || '').slice(0, 200));
          throw e;
        }
        const rows = (data && Array.isArray(data.items)) ? data.items : [];

        if (!rows.length) {
          if (mastersEmptyEl) mastersEmptyEl.style.display = '';
          try { mastersEl.style.display = 'none'; } catch (_) {}
          return;
        }
        if (mastersEmptyEl) mastersEmptyEl.style.display = 'none';
        try { mastersEl.style.display = ''; } catch (_) {}

        const fullNames = rows.map(r => String(r.name || '—'));
        const labels = fullNames.map(s => (s.length > 14 ? (s.slice(0, 13) + '…') : s));
        const values = rows.map(r => Number(r.total || 0));
        const colors = rows.map(r => String(r.color || '#64748b'));

        const mastersChart = new Chart(mastersEl, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'Расход', data: values, backgroundColor: colors }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  title: (items) => {
                    const idx = (items && items[0] && items[0].dataIndex) || 0;
                    return fullNames[idx] || '—';
                  },
                  label: (item) => {
                    const v = (item && typeof item.raw === 'number') ? item.raw : Number(item.raw || 0);
                    return String(v);
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  callback: (_v, idx) => labels[idx] || '',
                  color: (ctx) => colors[ctx.index] || '#64748b'
                }
              },
              y: { beginAtZero: true }
            }
          }
        });

        requestAnimationFrame(() => {
          try { mastersChart.resize(); mastersChart.update(); } catch (_) {}
        });
      } catch (e) {
        if (mastersEmptyEl) {
          mastersEmptyEl.textContent = 'Ошибка загрузки данных.';
          mastersEmptyEl.style.display = '';
        }
        try { mastersEl.style.display = 'none'; } catch (_) {}
        console.error('[stocks-dashboard] masters chart failed', e);
      }
    }

    loadMastersChart();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCharts, { once: true });
  } else {
    initCharts();
  }
</script>
{% endblock %}
