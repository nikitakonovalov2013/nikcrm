<div class="modal-header">
  <h3>Пользователь #{{ user.id }}</h3>
  <button class="btn-close" onclick="window.dispatchEvent(new CustomEvent('close-modal'))">✕</button>
</div>
<div class="modal-body" x-data="{confirm: {{ 'true' if confirm_initial else 'false' }} }">
  <form
    hx-post="/users/{{ user.id }}/update"
    hx-target="#modal-body"
    hx-swap="none"
    class="form-grid"
    hx-on:htmx:beforeRequest="this.querySelectorAll('button').forEach(b=>b.disabled=true)"
    hx-on:htmx:afterRequest="this.querySelectorAll('button').forEach(b=>b.disabled=false); if (event.detail.xhr && event.detail.xhr.status>=200 && event.detail.xhr.status<300) { window.refreshUsers && window.refreshUsers(); window.dispatchEvent(new CustomEvent('close-modal')); setTimeout(()=>window.dispatchEvent(new CustomEvent('close-modal')),0); }"
    hx-on:htmx:beforeSwap="if (event.detail.xhr && event.detail.xhr.status>=200 && event.detail.xhr.status<300) { window.refreshUsers && window.refreshUsers(); window.dispatchEvent(new CustomEvent('close-modal')); setTimeout(()=>window.dispatchEvent(new CustomEvent('close-modal')),0); event.detail.shouldSwap=false; }"
  >
    <label>
      Имя
      <input type="text" name="first_name" value="{{ user.first_name or '' }}" />
    </label>
    <label>
      Фамилия
      <input type="text" name="last_name" value="{{ user.last_name or '' }}" />
    </label>
    <label>
      Дата рождения
      <input type="date" name="birth_date" value="{{ user.birth_date }}" />
    </label>
    <label>
      Ставка, ₽
      <input type="number" name="rate_k" value="{{ user.rate_k or '' }}" />
    </label>
    <label>
      График
      <select name="schedule">
        <option value="">—</option>
        <option value="2/2" {% if user.schedule and user.schedule.value == '2/2' %}selected{% endif %}>2/2</option>
        <option value="5/2" {% if user.schedule and user.schedule.value == '5/2' %}selected{% endif %}>5/2</option>
        <option value="4/3" {% if user.schedule and user.schedule.value == '4/3' %}selected{% endif %}>4/3</option>
      </select>
    </label>
    <label>
      Должность
      <select name="position">
        <option value="">—</option>
        <option value="Руководитель" {% if user.position and user.position.value == 'Руководитель' %}selected{% endif %}>Руководитель</option>
        <option value="Сборщик заказов" {% if user.position and user.position.value == 'Сборщик заказов' %}selected{% endif %}>Сборщик заказов</option>
        <option value="Упаковщик" {% if user.position and user.position.value == 'Упаковщик' %}selected{% endif %}>Упаковщик</option>
        <option value="Мастер" {% if user.position and user.position.value == 'Мастер' %}selected{% endif %}>Мастер</option>
      </select>
    </label>
    <label>
      Статус
      <select name="status_value">
        {% set status_map = {
          'PENDING': 'На рассмотрении',
          'APPROVED': 'Одобрен',
          'REJECTED': 'Отклонён',
          'BLACKLISTED': 'В чёрном списке'
        } %}
        {% for s in ['PENDING','APPROVED','REJECTED','BLACKLISTED'] %}
        <option value="{{ s }}" {% if user.status.value == s %}selected{% endif %}>{{ status_map[s] }}</option>
        {% endfor %}
      </select>
    </label>
    <div class="form-row" style="grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 8px;">
      <button class="btn" type="submit">Сохранить</button>
      <button
        class="btn-warn"
        hx-post="/users/{{ user.id }}/blacklist"
        hx-target="#modal-body"
        hx-swap="none"
        hx-on:htmx:beforeRequest="this.disabled=true"
        hx-on:htmx:afterRequest="this.disabled=false; if (event.detail.xhr && event.detail.xhr.status>=200 && event.detail.xhr.status<300) { window.refreshUsers && window.refreshUsers(); window.dispatchEvent(new CustomEvent('close-modal')); setTimeout(()=>window.dispatchEvent(new CustomEvent('close-modal')),0); }"
        hx-on:htmx:beforeSwap="if (event.detail.xhr && event.detail.xhr.status>=200 && event.detail.xhr.status<300) { window.refreshUsers && window.refreshUsers(); window.dispatchEvent(new CustomEvent('close-modal')); setTimeout(()=>window.dispatchEvent(new CustomEvent('close-modal')),0); event.detail.shouldSwap=false; }"
        type="button"
      >В черный список</button>
      <button
        class="btn-danger"
        type="button"
        @click="confirm=true"
      >Удалить</button>
    </div>
  </form>
  <div class="divider"></div>
  <form hx-post="/users/{{ user.id }}/message" hx-target="#modal-body" hx-swap="none" class="form-row" style="display:flex; gap:8px; align-items:center;">
    <input type="text" name="text" placeholder="Текст сообщения" class="flex-1" />
    <button class="btn-outline" type="submit">Отправить</button>
  </form>
  <template x-if="confirm">
    <div style="position:absolute; inset:0; background:rgba(15,23,42,.5); display:flex; align-items:center; justify-content:center; padding:16px;">
      <div style="background:#fff; border-radius:12px; padding:16px; width:min(480px, 95%); box-shadow:0 10px 30px rgba(2,6,23,.2);">
        <div style="font-weight:600; margin-bottom:8px;">Подтверждение</div>
        <div style="margin-bottom:12px;">Вы уверены, что хотите удалить пользователя?</div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn-outline" type="button" @click="confirm=false">Отмена</button>
          <button
            class="btn-danger"
            type="button"
            hx-post="/users/{{ user.id }}/delete"
            hx-target="#modal-body"
            hx-swap="none"
            hx-on:htmx:beforeRequest="this.disabled=true"
            hx-on:htmx:afterRequest="this.disabled=false; if (event.detail.xhr && event.detail.xhr.status===204) { const row=document.getElementById('row-{{ user.id }}'); if (row) row.remove(); window.refreshUsers && window.refreshUsers(); window.dispatchEvent(new CustomEvent('close-modal')); setTimeout(()=>window.dispatchEvent(new CustomEvent('close-modal')),0); }"
            hx-on:htmx:beforeSwap="if (event.detail.xhr && event.detail.xhr.status===204) { const row=document.getElementById('row-{{ user.id }}'); if (row) row.remove(); window.refreshUsers && window.refreshUsers(); window.dispatchEvent(new CustomEvent('close-modal')); setTimeout(()=>window.dispatchEvent(new CustomEvent('close-modal')),0); event.detail.shouldSwap=false; }"
            hx-trigger="click"
            onclick="event.preventDefault(); try { htmx.ajax('POST', '/users/{{ user.id }}/delete', { target: '#modal-body', swap: 'none' }); } catch (e) { fetch('/users/{{ user.id }}/delete', { method: 'POST' }).then(()=>{ window.refreshUsers && window.refreshUsers(); window.dispatchEvent(new CustomEvent('close-modal')); }); }"
          >Удалить</button>
        </div>
      </div>
    </div>
  </template>
</div>
