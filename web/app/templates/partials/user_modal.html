<div class="modal-header">
  <h3>Пользователь #{{ user.id }}</h3>
</div>
<div class="modal-body" x-data="{confirm: {{ 'true' if confirm_initial else 'false' }} }">
  <form
    hx-post="users/{{ user.id }}/update"
    hx-target="#modal-body"
    hx-swap="innerHTML"
    class="form-grid"
    hx-on:htmx:beforeRequest="this.querySelectorAll('button').forEach(b=>b.disabled=true)"
    hx-on:htmx:afterRequest="this.querySelectorAll('button').forEach(b=>b.disabled=false)"
  >
    <label>
      Имя
      <input type="text" name="first_name" value="{{ user.first_name or '' }}" />
    </label>
    <label>
      Фамилия
      <input type="text" name="last_name" value="{{ user.last_name or '' }}" />
    </label>
    <label>
      Дата рождения
      <input type="date" name="birth_date" value="{{ user.birth_date }}" />
    </label>
    <label>
      Ставка, ₽
      <input type="number" name="rate_k" value="{{ user.rate_k or '' }}" />
    </label>
    <label>
      График
      <select name="schedule">
        <option value="">—</option>
        <option value="2/2" {% if user.schedule and user.schedule.value == '2/2' %}selected{% endif %}>2/2</option>
        <option value="5/2" {% if user.schedule and user.schedule.value == '5/2' %}selected{% endif %}>5/2</option>
        <option value="4/3" {% if user.schedule and user.schedule.value == '4/3' %}selected{% endif %}>4/3</option>
      </select>
    </label>
    <label>
      Должность
      <select name="position">
        <option value="">—</option>
        <option value="Руководитель" {% if user.position and user.position.value == 'Руководитель' %}selected{% endif %}>Руководитель</option>
        <option value="Сборщик заказов" {% if user.position and user.position.value == 'Сборщик заказов' %}selected{% endif %}>Сборщик заказов</option>
        <option value="Упаковщик" {% if user.position and user.position.value == 'Упаковщик' %}selected{% endif %}>Упаковщик</option>
        <option value="Мастер" {% if user.position and user.position.value == 'Мастер' %}selected{% endif %}>Мастер</option>
      </select>
    </label>
    <label>
      Статус
      <select name="status_value">
        {% set status_map = {
          'PENDING': 'На рассмотрении',
          'APPROVED': 'Одобрен',
          'REJECTED': 'Отклонён',
          'BLACKLISTED': 'В чёрном списке'
        } %}
        {% for s in ['PENDING','APPROVED','REJECTED','BLACKLISTED'] %}
        <option value="{{ s }}" {% if user.status.value == s %}selected{% endif %}>{{ status_map[s] }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Цвет
      <div class="user-color-field">
        <button type="button" class="user-color-trigger" id="user-color-trigger" aria-haspopup="dialog" aria-expanded="false" title="Выбрать цвет">
          <span id="user-color-preview" class="user-color-dot user-color-dot-lg" style="background: {{ user.color or '#64748B' }}"></span>
        </button>
        <div class="user-color-popover" id="user-color-popover" hidden>
          <div class="user-color-popover-body">
            <input id="user-color-picker" type="color" value="{{ user.color or '#64748B' }}" />
            <button type="button" class="btn" id="user-color-apply">Применить</button>
          </div>
        </div>
        <span style="position:relative; display:inline-flex; align-items:center;">
          <input
            id="user-color-hex"
            type="text"
            value="{{ user.color or '#64748B' }}"
            inputmode="text"
            autocapitalize="characters"
            spellcheck="false"
            oninput="(function(v){
              v = String(v||'').trim();
              try {
                document.getElementById('user-color-value').value = v;
                document.getElementById('user-color-preview').style.background = v;
              } catch(e){}
            })(this.value)"
            style="width:120px; padding-right:30px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"
          />
          <button
            type="button"
            title="Автоцвет"
            onclick="(function(){
              try {
                document.getElementById('user-color-value').value = '';
                document.getElementById('user-color-hex').value = '';
                document.getElementById('user-color-preview').style.background = '#ffffff';
              } catch(e){}
            })()"
            style="position:absolute; right:6px; width:20px; height:20px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#64748b; line-height:18px; padding:0; cursor:pointer;"
          >×</button>
        </span>
        <input id="user-color-value" type="hidden" name="color" value="{{ user.color or '#64748B' }}" />
      </div>
    </label>
    <script>
    (function(){
      try {
        const root = document.getElementById('modal-body') || document;
        const trigger = root.querySelector('#user-color-trigger');
        const pop = root.querySelector('#user-color-popover');
        const picker = root.querySelector('#user-color-picker');
        const applyBtn = root.querySelector('#user-color-apply');
        const hex = root.querySelector('#user-color-hex');
        const hidden = root.querySelector('#user-color-value');
        const preview = root.querySelector('#user-color-preview');
        if (!trigger || !pop || !picker || !applyBtn || !hex || !hidden || !preview) return;
        if (trigger.dataset.bound === '1') return;
        trigger.dataset.bound = '1';

        let draftColor = String(picker.value || '').trim();
        const open = () => {
          draftColor = String(picker.value || '').trim();
          pop.hidden = false;
          trigger.setAttribute('aria-expanded', 'true');
          try { picker.focus(); } catch(e){}
        };
        const close = () => {
          pop.hidden = true;
          trigger.setAttribute('aria-expanded', 'false');
        };
        const commit = (v) => {
          const val = String(v || '').trim();
          hidden.value = val;
          hex.value = val;
          preview.style.background = val;
          picker.value = val || picker.value;
        };

        trigger.addEventListener('click', (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          if (pop.hidden) open(); else close();
        });

        picker.addEventListener('input', () => {
          draftColor = String(picker.value || '').trim();
        });

        applyBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          commit(draftColor);
          close();
        });

        document.addEventListener('click', (ev) => {
          if (pop.hidden) return;
          const t = ev.target;
          if (pop.contains(t) || trigger.contains(t)) return;
          close();
        }, true);

        document.addEventListener('keydown', (ev) => {
          if (pop.hidden) return;
          if (ev.key === 'Escape') close();
        });
      } catch(e){}
    })();
    </script>
    <div class="form-row user-modal-actions" style="grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 8px;">
      <button class="btn" type="submit">Сохранить</button>
      <button
        class="btn-warn"
        hx-post="users/{{ user.id }}/blacklist"
        hx-target="#modal-body"
        hx-swap="innerHTML"
        hx-on:htmx:beforeRequest="this.disabled=true"
        hx-on:htmx:afterRequest="this.disabled=false"
        type="button"
      >В черный список</button>
      <button
        class="btn-danger"
        type="button"
        @click="confirm=true"
      >Удалить</button>
    </div>
  </form>
  <div class="divider"></div>
  <form hx-post="users/{{ user.id }}/message" hx-target="#modal-body" hx-swap="none" class="form-row user-modal-message" style="display:flex; gap:8px; align-items:center;">
    <input type="text" name="text" placeholder="Текст сообщения" class="flex-1" />
    <button class="btn-outline" type="submit">Отправить</button>
  </form>
  <template x-if="confirm">
    <div style="position:absolute; inset:0; background:rgba(15,23,42,.5); display:flex; align-items:center; justify-content:center; padding:16px;">
      <div style="background:#fff; border-radius:12px; padding:16px; width:min(480px, 95%); box-shadow:0 10px 30px rgba(2,6,23,.2);">
        <div style="font-weight:600; margin-bottom:8px;">Подтверждение</div>
        <div style="margin-bottom:12px;">Вы уверены, что хотите удалить пользователя?</div>
        <div class="user-modal-confirm-actions" style="display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn-outline" type="button" @click="confirm=false">Отмена</button>
          <button
            class="btn-danger"
            type="button"
            hx-post="users/{{ user.id }}/delete"
            hx-target="#modal-body"
            hx-swap="innerHTML"
            hx-on:htmx:beforeRequest="this.disabled=true"
            hx-on:htmx:afterRequest="this.disabled=false"
            hx-trigger="click"
            onclick="event.preventDefault(); try { htmx.ajax('POST', 'users/{{ user.id }}/delete', { target: '#modal-body', swap: 'innerHTML' }); } catch (e) { fetch('users/{{ user.id }}/delete', { method: 'POST' }); }"
          >Удалить</button>
        </div>
      </div>
    </div>
  </template>
</div>
